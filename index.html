<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatório de Produção Acadêmica - Biblioteconomia - Universidade Federal Fluminense</title>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-SBCVV8GMS8"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-SBCVV8GMS8');
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/wordcloud@1.2.2/src/wordcloud2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <link href="https://unpkg.com/vis-network/styles/vis-network.min.css" rel="stylesheet" type="text/css" />
    <style>
        .accordion-button {
            cursor: pointer;
            width: 100%;
            text-align: left;
            transition: background-color 0.2s ease;
        }
        .accordion-button:hover {
            background-color: #f9fafb; /* um cinza bem claro no hover */
        }
        .accordion-button .accordion-icon {
            transition: transform 0.3s ease;
        }
        .accordion-button.active .accordion-icon {
            transform: rotate(180deg);
        }
        .accordion-panel {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out;
            background-color: #ffffff; /* Fundo branco para o conteúdo */
        }

        #btn-voltar-topo {
            position: fixed;
            bottom: 80px;
            right: 20px;
            display: none; /* Começa escondido */
            transition: opacity 0.3s, visibility 0.3s;
            z-index: 100;
        }
    </style>
    <style>
        /* Estilo para a NAV quando o menu mobile estiver aberto */
        #main-nav.menu-aberto {
            position: fixed; /* Ocupa a tela por cima de tudo */
            inset: 0; /* Equivalente a top, right, bottom, left = 0 */
            height: 100vh; /* Garante 100% da altura da tela */
            overflow-y: auto; /* Permite scroll se necessário */
            background-color: white; /* Fundo branco sólido */
        }
        
        /* No estado aberto, esconde o cabeçalho e mostra o conteúdo do menu */
        #main-nav.menu-aberto .container {
            display: none;
        }
        #main-nav.menu-aberto #mobile-menu {
            display: flex;
        }
    </style>
    <style>
        /* --- Layout Desktop para as Novas Tabelas --- */
        /* Garante que os containers de estatísticas se expandam como células de tabela */
        .stats-cell {
            display: contents;
        }
        .stats-grid {
            display: contents;
        }
        .stat-item {
            display: table-cell; /* Faz cada item se comportar como uma célula <td> */
            padding: 1rem 1.5rem;
            vertical-align: middle;
        }
        .person-name-cell {
            padding: 1rem 1.5rem;
            vertical-align: middle;
        }
        /* Esconde os rótulos no desktop, mostrando apenas os valores */
        .stat-label { display: none; }
        .stat-value-text { display: table-cell; }
    
        /* --- Layout Mobile para as Novas Tabelas (o Card Compacto) --- */
        @media screen and (max-width: 768px) {
            .compact-card-table thead {
                display: none; /* Esconde o cabeçalho original */
            }
    
            /* A linha da tabela vira o card */
            .compact-card-table tr {
                display: block;
                border: 1px solid #e5e7eb;
                border-radius: 0.75rem;
                margin-bottom: 1rem;
                box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            }
    
            /* Ambas as células <td> agora se empilham verticalmente */
            .compact-card-table td {
                display: block;
                padding: 0;
                width: 100%;
            }
    
            /* O nome da pessoa vira o cabeçalho do card */
            .person-name {
                display: block;
                padding: 1rem;
                font-size: 1.125rem;
                font-weight: 600;
                border-bottom: 1px solid #e5e7eb;
                word-break: break-word; /* Resolve o problema do nome cortado */
            }
    
            /* O container de estatísticas vira uma grade */
            .stats-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr); /* Grade com 3 colunas */
                gap: 1px;
                background-color: #e5e7eb; /* Cor para as linhas da grade */
                overflow: hidden;
                border-bottom-left-radius: 0.75rem;
                border-bottom-right-radius: 0.75rem;
            }
            .stats-grid-autores {
                 grid-template-columns: repeat(2, 1fr); /* Grade com 2 colunas para autores */
            }
    
            /* Cada item de estatística */
            .stat-item {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 0.75rem 0.5rem;
                background-color: #fff;
                text-align: center;
            }
    
            /* Ocupa a linha inteira na grade (para a "Evolução Acadêmica") */
            .stat-item-full {
                grid-column: 1 / -1;
            }
            
            /* Mostra os rótulos no mobile */
            .stat-label {
                display: block;
                font-size: 0.75rem;
                color: #6b7280;
                margin-bottom: 0.25rem;
                font-weight: 500;
            }
    
            /* Estilo para os valores numéricos */
            .stat-value {
                font-size: 1.25rem;
                font-weight: 700;
                color: #1e3a8a;
            }
    
            /* Estilo para os valores em texto */
            .stat-value-text {
                font-size: 0.875rem;
                color: #374151;
                font-weight: 500;
            }
        }
    </style>
    <style>
        /* Estilos para a animação do banner de cookies */
        #cookie-consent-banner.show {
            transform: translateY(0);
        }
    </style>
    <!-- INÍCIO: NOVOS ESTILOS PARA FUNCIONALIDADES PLN -->
    <style>
        /* Estilos para entidades nomeadas destacadas no resumo */
        .entity {
            padding: 1px 4px;
            border-radius: 4px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .entity:hover {
            filter: brightness(1.1);
        }
        .entity-LOC { background-color: #dbeafe; color: #1e40af; } /* Localização */
        .entity-ORG { background-color: #dcfce7; color: #166534; } /* Organização */
        .entity-LEI { background-color: #fee2e2; color: #991b1b; } /* Lei */
        .entity-MISC { background-color: #f3e8ff; color: #581c87; } /* Miscelânea */
        .entity-PER { background-color: #fef3c7; color: #92400e; } /* Pessoa */

        /* Estilos para palavras-chave interativas no modal */
        .keyword-interactive {
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        .keyword-interactive:hover {
            background-color: #e0e7ff; /* light indigo */
            border-color: #a5b4fc;
        }

        /* Estilos para a seção de trabalhos semelhantes no modal */
        #similar-docs-container button {
            display: block;
            width: 100%;
            text-align: left;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s ease;
        }
        #similar-docs-container button:hover {
            background-color: #f3f4f6; /* gray-100 */
        }
    </style>
    <!-- FIM: NOVOS ESTILOS PARA FUNCIONALIDADES PLN -->
    <style>
        /* Estilos para o modal e a funcionalidade de resumo expandido */
        .modal-body-grid {
            display: grid;
            grid-template-columns: repeat(1, minmax(0, 1fr));
            gap: 1rem 2rem;
        }
        @media (min-width: 768px) {
            .modal-body-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }
        
        /* Controla a visibilidade dos elementos quando o resumo está expandido */
        #modal-trabalho.modal-abstract-expanded .hidable-on-abstract,
        #modal-trabalho.modal-abstract-expanded #modal-actions {
            display: none;
        }

        #modal-trabalho.modal-abstract-expanded #modal-abstract-content {
            display: block; /* Garante que o resumo seja visível */
        }
    </style>
    <style>
        @media screen and (max-width: 768px) {
            .responsive-table table, 
            .responsive-table thead, 
            .responsive-table tbody, 
            .responsive-table th, 
            .responsive-table td, 
            .responsive-table tr {
                display: block;
            }

            /* Esconde o cabeçalho original da tabela em telas pequenas */
            .responsive-table thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }

            /* Transforma cada linha em um card */
            .responsive-table tr {
                border: 1px solid #e5e7eb;
                border-radius: 0.5rem;
                margin-bottom: 1rem;
                box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            }

            .responsive-table td {
                /* Comporta-se como uma "linha" dentro do card */
                border: none;
                border-bottom: 1px solid #f3f4f6;
                position: relative;
                padding-left: 50%; /* Espaço para o rótulo */
                text-align: right;
                padding-top: 0.75rem;
                padding-bottom: 0.75rem;
            }

            .responsive-table td:before {
                /* Cria o rótulo da coluna (ex: "TCCs:", "Teses:") */
                position: absolute;
                top: 50%;
                left: 1.5rem; /* Alinhamento do rótulo */
                transform: translateY(-50%);
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: 600;
                color: #1f2937; /* Cor do texto do rótulo */
                content: attr(data-label); /* Pega o texto do atributo data-label */
            }

            /* Remove borda da última célula do card */
            .responsive-table td:last-child {
                border-bottom: 0;
            }
        }
    </style>
    <style>
        @media screen and (max-width: 768px) {
            /* * CORREÇÃO: A regra agora esconde APENAS o cabeçalho (thead),
             * permitindo que o corpo da tabela (tbody) e suas linhas (tr) fiquem visíveis.
            */
            .normalization-table thead {
                display: none;
            }

            .normalization-table table,
            .normalization-table tbody,
            .normalization-table tr,
            .normalization-table td {
                display: block; /* Garante que todos os elementos se comportem como blocos */
            }

            .normalization-table tr {
                background-color: #ffffff;
                border: 1px solid #e5e7eb;
                border-radius: 0.75rem; /* 12px */
                box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
                margin-bottom: 1rem; /* 16px */
                overflow: hidden;
            }

            .normalization-table td {
                padding: 0.75rem 1rem; /* 12px 16px */
                border-bottom: 1px solid #f3f4f6;
            }
            .normalization-table tr td:last-child {
                border-bottom: none;
            }

            /* Estilo especial para a primeira célula (Nome Normalizado) -> Título do Card */
            .normalization-table td:first-child {
                background-color: #f9fafb; /* Cinza claro */
                font-weight: 600;
                font-size: 1.125rem; /* text-lg */
                color: #1e3a8a; /* Azul escuro */
            }

            /* Adiciona o rótulo antes das outras células */
            .normalization-table td:not(:first-child)::before {
                content: attr(data-label);
                display: block;
                font-weight: 600;
                color: #4b5563; /* Cinza médio */
                margin-bottom: 0.25rem;
            }
        }
    </style>
    <style>
        
        /* Estilos para visualização em tela */
        @media screen {
            .wordcloud-canvas {
                width: 100%;
                height: 400px;
                border: 1px solid #e5e7eb;
                border-radius: 0.5rem;
            }
            
            /* Melhorar a acessibilidade do modal */
            #modal-trabalho {
                transition: opacity 0.3s ease;
            }
            
            /* Melhorar a experiência de filtros */
            #filtros select {
                transition: border-color 0.2s ease;
            }
            
            #filtros select:focus {
                border-color: #3b82f6;
                outline: none;
                box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
            }
            
            /* Estilização da paginação */
            #paginacao button:disabled {
                cursor: not-allowed;
            }
            
            /* Estilização dos cards de trabalhos */
            #lista-trabalhos > div {
                transition: transform 0.2s ease, box-shadow 0.2s ease;
            }
            
            #lista-trabalhos > div:hover {
                transform: translateY(-2px);
            }
        }
    </style>
    <style>
        /* Estilos para impressão - VERSÃO MELHORADA */
        @media print {
            /* Define as margens da página e remove informações do cabeçalho/rodapé do navegador */
            @page {
                size: A4;
                margin: 2cm 1.5cm;
            }

            body {
                font-family: "Times New Roman", Times, serif;
                font-size: 11pt;
                line-height: 1.4;
                color: #000;
                background-color: #fff !important;
            }

            /* Esconde elementos de interface que não fazem sentido na impressão */
            .no-print, header nav, #filtros, #paginacao, footer, #modal-trabalho, .sumario-interativo {
                display: none !important;
            }

            /* Garante que o container principal ocupe toda a largura */
            .container {
                width: 100% !important;
                max-width: 100% !important;
                padding: 0 !important;
                margin: 0 !important;
                box-shadow: none !important;
            }

            /* Estiliza o cabeçalho do documento */
            header {
                text-align: center;
                border-bottom: 2px solid #000;
                padding-bottom: 1cm;
                margin-bottom: 1cm;
                page-break-after: avoid;
            }
            header h1 { font-size: 22pt; }
            header h2 { font-size: 16pt; border: none; }

            /* Estilos para títulos de seção */
            h2 {
                font-size: 16pt;
                font-weight: bold;
                margin-top: 1.5cm;
                margin-bottom: 0.8cm;
                border-bottom: 1px solid #000;
                padding-bottom: 0.2cm;
                page-break-after: avoid; /* Evita que a página quebre logo após um título */
            }

            /* Força quebras de página antes de seções principais para melhor organização */
            .print-break {
                page-break-before: always;
            }

            /* Remove sombras, bordas arredondadas e cores de fundo desnecessárias */
            .shadow, .shadow-lg, .shadow-md, .rounded-lg, .rounded-xl, .rounded-full, .bg-white, .bg-gray-50, .bg-blue-100 {
                box-shadow: none !important;
                border-radius: 0 !important;
                background-color: transparent !important;
                border: none !important;
            }

            /* Força layouts de grid e flex para um fluxo de bloco, que é mais seguro para impressão */
            .grid, .flex {
                display: block !important;
            }

            /* Melhora a apresentação da lista de trabalhos */
            #lista-trabalhos {
                display: block !important;
            }
            #lista-trabalhos > div {
                display: block !important;
                border-top: 1px solid #ccc;
                padding-top: 0.5cm;
                margin-bottom: 0.5cm;
                page-break-inside: avoid; /* Tenta manter cada card em uma única página */
            }
            #lista-trabalhos h3 {
                font-size: 12pt;
                font-weight: bold;
            }

            /* Garante que as tabelas fiquem legíveis */
            table {
                width: 100%;
                border-collapse: collapse;
                font-size: 9pt;
                page-break-inside: avoid;
            }
            th, td {
                border: 1px solid #000;
                padding: 0.2cm;
                text-align: left;
            }
            th {
                background-color: #e0e0e0 !important; /* Cor de fundo para cabeçalhos de tabela */
                font-weight: bold;
            }
            tbody tr:nth-child(even) {
                background-color: #f5f5f5 !important; /* Linhas zebradas para melhor leitura */
            }

            /* Garante que os gráficos (canvas) se ajustem à página */
            canvas {
                max-width: 100% !important;
                height: auto !important;
            }
            
            /* Formata links para serem claramente identificáveis na impressão */
            a {
                color: #000 !important;
                text-decoration: underline !important;
            }
            a[href]:after {
                /* Opcional: mostra a URL completa após o link */
                /* content: " (" attr(href) ")"; */
                /* font-size: 9pt; */
            }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div id="loading-indicator" class="fixed inset-0 bg-white flex items-center justify-center z-50">
        <div class="text-center">
            <p class="text-lg font-semibold text-gray-700">Carregando dados do repositório...</p>
            <p class="text-sm text-gray-500 mt-2">Por favor, aguarde.</p>
        </div>
    </div>
    <button id="btn-voltar-topo" class="bg-blue-600 text-white rounded-full p-3 shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" />
        </svg>
    </button>
    <div id="cookie-consent-banner" class="fixed bottom-0 left-0 right-0 bg-gray-900 bg-opacity-90 backdrop-blur-sm text-white p-4 z-50 transform translate-y-full transition-transform duration-500 ease-in-out">
        <div class="container mx-auto flex flex-col md:flex-row justify-between items-center space-y-3 md:space-y-0">
            <p class="text-sm text-center md:text-left">
                Este site utiliza cookies, incluindo o Google Analytics, para analisar o tráfego e melhorar sua experiência de navegação. Ao continuar, você concorda com nosso uso de cookies.
            </p>
            <button id="accept-cookie-consent" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-5 rounded-lg whitespace-nowrap">
                Aceitar
            </button>
        </div>
    </div>

    <nav id="main-nav" class="bg-white/70 backdrop-blur-lg sticky top-0 z-40 w-full border-b border-gray-200 transition-all duration-300">
        
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center h-16">
                <div class="flex-shrink-0">
                    <a href="#" class="text-xl font-bold text-blue-700">RI/UFF Insights</a>
                </div>
    
                <div class="hidden md:flex md:items-center md:space-x-4">
                    <a href="#dados-gerais" class="text-gray-600 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">Dados Gerais</a>
                    <a href="#trabalhos" class="text-gray-600 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">Trabalhos</a>
                    <a href="#indice-orientadores" class="text-gray-600 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">Índices</a>
                    <a href="#mapa-tematico" class="text-gray-600 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">Temas</a>
                    <a href="#nuvem-palavras" class="text-gray-600 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">Nuvem</a>
                    <a href="#rede-colaboracao-secao" class="text-gray-600 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">Redes</a>
                    <a href="#mapa-ciencia-secao" class="text-gray-600 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">Ciência</a> 
                    <a href="#temas-evolucao-secao" class="text-gray-600 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">Evolução<a>
                    <a href="#jornada-autor-secao" class="text-gray-600 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">Jornada</a>
                    <a href="#infometricos-secao" class="text-gray-600 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">Infometria</a>
                    
                </div>
    
                <div class="md:hidden flex items-center">
                    <button id="hamburger-btn" class="inline-flex items-center justify-center p-2 rounded-md text-gray-700 hover:text-gray-900 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500">
                        <span class="sr-only">Abrir menu principal</span>
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>
                    </div>
            </div>
        </div>
    
        <div id="mobile-menu" class="hidden h-full w-full flex-col items-center justify-center p-6 text-center">
            <button id="close-menu-btn" class="absolute top-4 right-4 p-2 text-gray-600 hover:text-gray-900">
                <span class="sr-only">Fechar menu</span>
                <svg class="h-8 w-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>

            <h2 class="text-xl font-bold text-blue-700 mb-8">Navegação</h2>
            <div class="flex flex-col space-y-4">
                <a href="#dados-gerais" class="mobile-menu-link text-xl text-gray-700 hover:text-blue-600">Dados Gerais</a>
                <a href="#trabalhos" class="mobile-menu-link text-xl text-gray-700 hover:text-blue-600">Lista de Trabalhos</a>
                <a href="#indice-orientadores" class="mobile-menu-link text-xl text-gray-700 hover:text-blue-600">Índices (Autor e Orientador)</a>
                <a href="#mapa-tematico" class="mobile-menu-link text-xl text-gray-700 hover:text-blue-600">Mapa Temático (Temas e Assuntos)</a>
                <a href="#nuvem-palavras" class="mobile-menu-link text-xl text-gray-700 hover:text-blue-600">Nuvem de Palavras</a>
                <a href="#rede-colaboracao-secao" class="mobile-menu-link text-xl text-gray-700 hover:text-blue-600">Rede de Colaboração</a>
                <a href="#mapa-ciencia-secao" class="mobile-menu-link text-xl text-gray-700 hover:text-blue-600">Mapa da Ciência</a>
                <a href="#temas-evolucao-secao" class="mobile-menu-link text-xl text-gray-700 hover:text-blue-600">Evolução Temática</a>
                <a href="#jornada-autor-secao" class="mobile-menu-link text-xl text-gray-700 hover:text-blue-600">Jornada do Autor</a>
                <a href="#infometricos-secao" class="mobile-menu-link text-xl text-gray-700 hover:text-blue-600">Infometria</a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
        <!-- Cabeçalho -->
        <header class="text-center mb-6 flex flex-col items-center">
            <h1 class="text-4xl font-bold mb-2">Repositório Institucional da Universidade Federal Fluminense</h1>
            <h2 class="text-2xl text-blue-700">Insights sobre trabalhos acadêmicos publicados no programa de graduação em Biblioteconomia e Documentação e pós-graduação Ciência da Informação da UFF</h2>
            <p class="mt-4 text-gray-600">Relatório gerado em <span id="current-date"></span></p>
            <p class="mt-1 mb-3 text-gray-600">Dataset obtido em <span id="dataset-date"></span></p>
            <!-- <button id="btn-export-pdf" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                Exportar PDF
            </button> -->
        </header>

        <!-- Dados Gerais -->
        <section id="dados-gerais" class="mb-4 print-break">
            <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Dados Gerais</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white p-4 md:p-6 rounded-lg shadow-lg text-center flex flex-col items-center justify-center">
                    <div class="bg-blue-100 p-3 rounded-full w-16 h-16 mx-auto mb-4 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                        </svg>
                    </div>
                    <h3 class="text-lg font-medium text-blue-700 mb-2">Total de Trabalhos</h3>
                    <p class="text-4xl font-bold text-gray-800" id="total-trabalhos">0</p>
                </div>
                <div class="bg-white p-4 md:p-6 rounded-lg shadow-lg flex flex-col items-center justify-center">
                    <h3 class="text-lg font-medium text-blue-700 mb-4 text-center">Distribuição por Tipo</h3>
                    <ul id="tipo-trabalhos" class="space-y-3">
                        <!-- Será preenchido via JavaScript -->
                    </ul>
                </div>
                <div class="bg-white p-4 md:p-6 rounded-lg shadow-lg flex flex-col items-center justify-center">
                    <h3 class="text-lg font-medium text-blue-700 mb-4 text-center">Distribuição Temporal</h3>
                    <div class="relative bg-white p-4 rounded-lg border h-[250px]">
                        <canvas id="grafico-temporal"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- Filtros -->
        <section id="filtros" class="mb-8 no-print">
            <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Filtros</h2>
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Área Temática</label>
                        <select id="filtro-area" class="w-full p-2 border rounded">
                            <option value="">Todas as áreas</option>
                            </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ano de Defesa</label>
                        <select id="filtro-ano" class="w-full p-2 border rounded">
                            <option value="">Todos os anos</option>
                            </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Orientador</label>
                        <select id="filtro-orientador" class="w-full p-2 border rounded">
                            <option value="">Todos os orientadores</option>
                            </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Trabalho</label>
                        <select id="filtro-tipo" class="w-full p-2 border rounded">
                            <option value="">Todos os tipos</option>
                            <option value="TCC">TCC</option>
                            <option value="Dissertação">Dissertação</option>
                            <option value="Tese">Tese</option>
                        </select>
                    </div>
                    <!-- INÍCIO: NOVA SEÇÃO DE FILTRO POR TÓPICOS -->
                    <div class="md:col-span-4 lg:col-span-4 mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Explorar por Tópicos Principais</label>
                        <div id="topic-filters" class="flex flex-wrap gap-2">
                            <!-- Botões de tópico serão inseridos aqui pelo JavaScript -->
                        </div>
                    </div>
                    <!-- FIM: NOVA SEÇÃO DE FILTRO POR TÓPICOS -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Metodologia</label>
                        <select id="filtro-metodologia" class="w-full p-2 border rounded">
                            <option value="">Todas as metodologias</option>
                        </select>
                    </div>
                </div>
                <div class="mt-4 flex justify-end">
                    <button id="btn-aplicar-filtros" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Aplicar Filtros</button>
                    <button id="btn-limpar-filtros" class="ml-2 bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400">Limpar Filtros</button>
                </div>
                <div id="filtros-ativos-container" class="mt-4 pt-4 border-t border-gray-200">
                </div>
            </div>
        </section>


        <!-- Lista de Trabalhos Publicados -->
        <section id="trabalhos" class="mb-12 print-break">
            <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Lista de Trabalhos</h2>
            
            <div class="mb-4">
                <label for="filtro-busca-textual" class="block text-sm font-medium text-gray-700 mb-1">Refinar lista atual:</label>
                <input type="search" id="filtro-busca-textual" placeholder="Buscar nos resultados por título, autor, resumo, palavra-chave..." class="w-full p-2 border rounded shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 transition">
            </div>

            <div id="info-trabalhos" class="mb-4 text-sm text-gray-600"></div>
            <div id="lista-trabalhos" class="space-y-6 relative">
                <!-- Trabalhos serão carregados aqui via JavaScript -->
            </div>
            
            <!-- Paginação -->
            <div id="paginacao" class="mt-8 flex justify-center no-print">
                <!-- Paginação será gerada via JavaScript -->
            </div>
        </section>

        <!-- Índice de Orientadores -->
        <section id="indice-orientadores" class="mb-12 print-break">
            <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Índice de Orientadores</h2>
            <div class="mb-4">
                <input type="search" id="busca-orientadores" placeholder="Buscar orientador pelo nome..." class="w-full md:w-1/2 p-2 border rounded shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 transition">
            </div>
            <div id="tabela-orientadores" class="compact-card-table md:bg-white md:rounded-lg md:shadow overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Orientador</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">TCCs</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dissertações</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Teses</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Participações em Bancas</th>
                        </tr>
                    </thead>
                    <tbody id="corpo-tabela-orientadores" class="md:bg-white md:divide-y divide-gray-200">
                        <!-- Conteúdo será preenchido via JavaScript -->
                    </tbody>
                </table>
            </div>
            <div id="orientadores-ver-mais-container" class="text-center mt-4 no-print"></div>
        </section>

        <!-- Índice de Autores -->
        <section id="indice-autores" class="mb-12 print-break">
            <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Índice de Autores</h2>
            <div class="mb-4">
                <input type="search" id="busca-autores" placeholder="Buscar autor pelo nome..." class="w-full md:w-1/2 p-2 border rounded shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 transition">
            </div>
            <div id="tabela-autores" class="compact-card-table md:bg-white md:rounded-lg md:shadow overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Autor</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">TCCs</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dissertações</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Teses</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Evolução Acadêmica</th>
                        </tr>
                    </thead>
                    <tbody id="corpo-tabela-autores" class="md:bg-white md:divide-y divide-gray-200">
                        <!-- Conteúdo será preenchido via JavaScript -->
                    </tbody>
                </table>
            </div>
            <div id="autores-ver-mais-container" class="text-center mt-4 no-print"></div>
        </section>

        <!-- Evolução Acadêmica -->
        <section id="evolucao-academica" class="mb-12 print-break">
            <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Evolução Acadêmica</h2>
            <div class="bg-white p-4 md:p-6 rounded-lg shadow">
                <p class="mb-4">Esta seção mostra autores que progrediram em sua carreira acadêmica, apresentando trabalhos em diferentes níveis (TCC → Dissertação → Tese).</p>
                <div id="lista-evolucao" class="grid md:grid-cols-2 gap-4">
                    <!-- Conteúdo será preenchido via JavaScript -->
                </div>
            </div>
        </section>

        <section id="mapa-tematico" class="mb-12 print-break">
            <h2 class="text-2xl font-semibold mb-6 border-b pb-3 text-blue-800">Mapa Temático da Produção Acadêmica</h2>
            <div class="mb-4 p-4 bg-amber-50 border border-amber-200 rounded-lg text-sm text-amber-800" role="alert">
                <span class="font-bold">Legenda:</span> O ícone 🚩 indica um dos 10 temas ou assuntos com maior número de trabalhos acadêmicos associados no repositório.
            </div>

            <div class="mb-4">
                <input type="search" id="busca-mapa-tematico" placeholder="Buscar tema pelo nome..." class="w-full md:w-1/2 p-2 border rounded shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 transition">
            </div>

            <div class="bg-white p-4 md:p-6 rounded-xl shadow-lg border border-gray-100 space-y-8">
                
                <div>
                    <h3 class="text-xl font-semibold mb-4 text-gray-700">Visão Geral dos Temas</h3>
                    <div id="tabela-mapa-tematico" class="responsive-table overflow-hidden md:border md:rounded-lg">
                        <table class="min-w-full md:divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tema Principal (Descritor)</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">TCCs</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Dissertações</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Teses</th>
                                </tr>
                            </thead>
                            <tbody id="corpo-tabela-temas" class="md:bg-white md:divide-y divide-gray-200">
                                </tbody>
                        </table>
                    </div>
                    <div id="temas-ver-mais-container" class="text-center mt-4 no-print"></div>
                </div>

                <div class="border-t pt-8">
                    <h3 class="text-xl font-semibold mb-4 text-gray-700">Explore um Tema</h3>
                    <div class="mb-6">
                        <label for="filtro-mapa-tema" class="block text-sm font-medium text-gray-700 mb-2">Selecione uma área temática para ver detalhes sobre autores, orientadores e assuntos relacionados:</label>
                        <select id="filtro-mapa-tema" class="w-full md:w-2/3 p-2 border rounded-md focus:border-blue-500 focus:ring focus:ring-blue-200 transition">
                            <option value="">-- Selecione um tema --</option>
                            </select>
                    </div>
                    
                    <div id="detalhes-tema-container" class="hidden transition-opacity duration-300 bg-gray-50 p-6 rounded-lg border">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            
                            <div class="lg:col-span-1">
                                <h4 class="text-lg font-semibold text-gray-800 mb-3 border-b pb-2">Assuntos Relacionados</h4>
                                <ul id="lista-assuntos-tema" class="space-y-1 text-sm text-gray-700 max-h-60 overflow-y-auto pr-2">
                                    </ul>
                            </div>
                            
                            <div class="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div>
                                    <h4 class="text-lg font-semibold text-gray-800 mb-3 border-b pb-2">Autores</h4>
                                    <ul id="lista-autores-tema" class="space-y-1 text-sm text-gray-700 max-h-60 overflow-y-auto pr-2">
                                        </ul>
                                </div>
                                <div>
                                    <h4 class="text-lg font-semibold text-gray-800 mb-3 border-b pb-2">Orientadores</h4>
                                    <ul id="lista-orientadores-tema" class="space-y-1 text-sm text-gray-700 max-h-60 overflow-y-auto pr-2">
                                        </ul>
                                </div>
                            </div>

                        </div>
                    </div>
                    <div id="prompt-tema" class="text-center text-gray-500 mt-4">
                        <p>Selecione um tema na lista acima para visualizar os detalhes.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Seção de Normalização de Nomes -->
        <section id="normalizacao-nomes" class="mb-12 print-break">
            <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Normalização de Nomes</h2>
            <div class="bg-white p-4 md:p-6 rounded-lg shadow">
                <p class="mb-4">Esta seção apresenta os nomes que foram identificados com possíveis duplicações ou variações e como foram normalizados para garantir consistência nos dados.</p>
                
                <div class="overflow-x-auto normalization-table">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome Normalizado (Correto)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Variações Encontradas</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                            </tr>
                        </thead>
                        <tbody id="tabela-normalizacao" class="bg-white divide-y divide-gray-200">
                            <!-- Conteúdo será preenchido via JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-4 p-4 bg-blue-50 rounded-lg">
                    <h3 class="font-semibold text-blue-800 mb-2">Legenda:</h3>
                    <ul class="text-sm text-blue-700 space-y-1">
                        <li>• <span class="font-medium">Orientador:</span> Professor responsável pela orientação do trabalho</li>
                        <li>• <span class="font-medium">Membro de Banca:</span> Professor que participou da banca examinadora</li>
                        <li>• <span class="font-medium">Autor:</span> Autor do trabalho acadêmico</li>
                    </ul>
                </div>
            </div>
        </section>

        <section id="infometricos-secao" class="mb-12 print-break">
            <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Indicadores Infométricos do Repositório</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white p-4 md:p-6 rounded-lg shadow">
                    <h3 class="text-lg font-medium text-blue-700 mb-4 text-center">Tempo entre Defesa e Disponibilização Online</h3>
                    <div class="relative h-[300px]">
                        <canvas id="grafico-time-to-online"></canvas>
                    </div>
                    <p class="text-xs text-gray-500 mt-2 text-center">Mede a eficiência do processo de publicação no repositório.</p>
                </div>
                <div class="bg-white p-4 md:p-6 rounded-lg shadow">
                    <h3 class="text-lg font-medium text-blue-700 mb-4 text-center">Distribuição de Licenças de Acesso Aberto</h3>
                    <div class="relative h-[300px]">
                        <canvas id="grafico-licencas"></canvas>
                    </div>
                    <p class="text-xs text-gray-500 mt-2 text-center">Mostra a adesão a diferentes tipos de licenças Creative Commons.</p>
                </div>
            </div>
        </section>

        <!-- Nuvem de Palavras -->
        <section id="nuvem-palavras" class="mb-12 print-break">
            <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Nuvem de Palavras</h2>
            <div class="bg-white p-4 md:p-6 rounded-lg shadow">
                <div class="wordcloud-canvas" id="nuvem-palavras-canvas"></div>
                <div id="legenda-nuvem" class="mt-4 text-sm text-gray-600">
                    <!-- Legenda será preenchida via JavaScript -->
                </div>
            </div>
        </section>

        <!-- Redes de Colaboração -->
        <section id="rede-colaboracao-secao" class="mb-12 print-break">
            <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Análise de Redes de Colaboração</h2>
            <div class="bg-white p-4 md:p-6 rounded-lg shadow">
        
                <div class="p-4 lg:p-6 border-t">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-1">
                            <div class="mb-6 bg-gray-50 p-4 rounded-lg border">
                                <h3 class="text-lg font-medium text-blue-700 mb-4">Controles da Rede</h3>
                                <div class="space-y-4">
                                    <div>
                                        <label for="slider-pesquisadores" class="block text-sm font-medium text-gray-700">Nº de pesquisadores a exibir (por centralidade):</label>
                                        <input type="range" id="slider-pesquisadores" min="10" max="150" value="50" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                        <span id="valor-slider-pesquisadores" class="text-sm text-blue-600 font-semibold">50 pesquisadores</span>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipos de Vínculos a Exibir:</label>
                                        <div class="space-y-2">
                                            <label class="flex items-center">
                                                <input type="checkbox" id="check-orientadores" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                                                <span class="ml-2 text-sm text-gray-700">Orientadores</span>
                                            </label>
                                            <label class="flex items-center">
                                                <input type="checkbox" id="check-autores" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                                                <span class="ml-2 text-sm text-gray-700">Autores</span>
                                            </label>
                                            <label class="flex items-center">
                                                <input type="checkbox" id="check-bancas" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                                                <span class="ml-2 text-sm text-gray-700">Membros de Banca</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                
                            <div class="text-center mb-6">
                                 <button id="btn-render-rede" class="bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700 transition-colors w-full">
                                    Gerar / Atualizar Rede
                                </button>
                            </div>
                            
                            <div>
                                <h3 class="text-lg font-medium text-blue-700 mb-2">Pesquisadores Mais Centrais</h3>
                                <p class="text-xs text-gray-500 mb-2">(visíveis na rede atual)</p>
                                <div id="metricas-rede" class="space-y-2 text-sm text-gray-700 max-h-60 overflow-y-auto">
                                    </div>
                            </div>
                        </div>
                
                        <div class="lg:col-span-2">
                             <div id="rede-colaboracao-placeholder" class="flex items-center justify-center h-full border rounded-lg bg-gray-50 p-8">
                                 <p class="text-center text-gray-600">Ajuste os controles e clique em "Gerar / Atualizar Rede" para criar a visualização.</p>
                            </div>
                            <div id="rede-colaboracao-wrapper" class="hidden">
                                 <div class="flex justify-end mb-2">
                                    <button id="btn-fechar-rede" class="text-sm bg-gray-200 text-gray-700 px-3 py-1 rounded hover:bg-gray-300 transition-colors">
                                        &times; Fechar Rede
                                    </button>
                                </div>
                                <div id="rede-colaboracao-container" class="border rounded-lg" style="height: 600px; width: 100%;">
                                    </div>
                            </div>
                        </div>
                    </div>
                </div>
        
            </div>
        </section>

        <section id="mapa-ciencia-secao" class="mb-12 print-break">
            <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Análise de Coocorrência de Temas (Mapa da Ciência)</h2>
            <div class="bg-white p-4 md:p-6 rounded-lg shadow">
        
                <div class="p-4 lg:p-6 border-t">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-1">
                            <div class="mb-6 bg-gray-50 p-4 rounded-lg border">
                                <h3 class="text-lg font-medium text-blue-700 mb-4">Controles do Gráfico</h3>
                                <div class="space-y-4">
                                    <div>
                                        <label for="slider-temas" class="block text-sm font-medium text-gray-700">Número de temas a exibir:</label>
                                        <input type="range" id="slider-temas" min="10" max="100" value="30" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                        <span id="valor-slider-temas" class="text-sm text-blue-600 font-semibold">30 temas</span>
                                    </div>
                                    <div>
                                        <label for="slider-conexoes" class="block text-sm font-medium text-gray-700">Força mínima da conexão:</label>
                                        <input type="range" id="slider-conexoes" min="2" max="10" value="2" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                        <span id="valor-slider-conexoes" class="text-sm text-blue-600 font-semibold">2 coocorrências</span>
                                    </div>
                                </div>
                            </div>
                
                            <div class="text-center mb-6">
                                 <button id="btn-render-mapa" class="bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700 transition-colors w-full">
                                    Gerar / Atualizar Mapa
                                </button>
                            </div>
                
                            <div>
                                <h3 class="text-lg font-medium text-blue-700 mb-2">Pares de Temas Mais Fortes</h3>
                                <p class="text-xs text-gray-500 mb-2">(com base nos filtros atuais)</p>
                                <div id="metricas-mapa-ciencia" class="space-y-2 text-sm text-gray-700 max-h-60 overflow-y-auto">
                                    </div>
                            </div>
                        </div>
                
                        <div class="lg:col-span-2">
                            <div id="mapa-ciencia-placeholder" class="flex items-center justify-center h-full border rounded-lg bg-gray-50 p-8">
                                 <p class="text-center text-gray-600">Ajuste os controles e clique em "Gerar / Atualizar Mapa" para criar a visualização.</p>
                            </div>
                            <div id="mapa-ciencia-container" class="border rounded-lg hidden" style="height: 600px; width: 100%;">
                                </div>
                        </div>
                    </div>
                </div>
                
                
            </div>
        </section>

        <section id="temas-evolucao-secao" class="mb-12 print-break">
            <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Evolução dos Temas de Pesquisa</h2>
            <div class="bg-white p-4 md:p-6 rounded-lg shadow">
                <div class="mb-4">
                    <label for="filtro-tema" class="block text-sm font-medium text-gray-700 mb-1">Selecione uma Palavra-Chave para analisar sua frequência ao longo dos anos:</label>
                    <select id="filtro-tema" class="w-full md:w-1/2 p-2 border rounded focus:border-blue-500 focus:ring focus:ring-blue-200 transition">
                        <option value="">-- Selecione um tema --</option>
                        </select>
                </div>
                <div id="grafico-evolucao-container" style="height: 400px;">
                    <canvas id="grafico-evolucao-tema"></canvas>
                </div>
                <p id="grafico-prompt" class="text-center text-gray-500 mt-4">Selecione um tema acima para visualizar o gráfico.</p>
            </div>
        </section>

        <section id="jornada-autor-secao" class="mb-12 print-break">
            <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Análise da Jornada do Autor</h2>
            <div class="bg-white p-4 md:p-6 rounded-lg shadow">
                <div class="mb-6">
                    <label for="filtro-autor-jornada" class="block text-sm font-medium text-gray-700 mb-1">Selecione um autor para ver sua trajetória acadêmica detalhada:</label>
                    <select id="filtro-autor-jornada" class="w-full md:w-1/2 p-2 border rounded focus:border-blue-500 focus:ring focus:ring-blue-200 transition">
                        <option value="">-- Selecione um autor --</option>
                        </select>
                </div>
                <div id="jornada-autor-resultado" class="border-t pt-6">
                    <p class="text-center text-gray-500">Selecione um autor na lista acima para visualizar os detalhes.</p>
                </div>
            </div>
        </section>

        <section id="entidades-destaque-secao" class="mb-12 print-break">
            <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Entidades em Destaque nos Resumos</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white p-4 md:p-6 rounded-lg shadow">
                    <h3 class="text-lg font-medium text-blue-700 mb-4 text-center">Top 10 Organizações Citadas</h3>
                    <div class="relative h-[400px]">
                        <canvas id="grafico-entidades-org"></canvas>
                    </div>
                </div>
                <div class="bg-white p-4 md:p-6 rounded-lg shadow">
                    <h3 class="text-lg font-medium text-blue-700 mb-4 text-center">Top 10 Localidades Citadas</h3>
                    <div class="relative h-[400px]">
                        <canvas id="grafico-entidades-loc"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <section id="metodologias-secao" class="mb-12 print-break">
            <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Metodologias de Pesquisa Mais Utilizadas</h2>
            <div class="bg-white p-4 md:p-6 rounded-lg shadow">
                <div class="relative h-[400px]">
                    <canvas id="grafico-metodologias"></canvas>
                </div>
            </div>
        </section>

        <section id="sobre-o-projeto" class="mb-12 print-break">
            <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Sobre o Projeto</h2>
            <div class="bg-white p-6 rounded-lg shadow space-y-4 text-gray-700">
                <div>
                    <h3 class="text-lg font-semibold text-blue-700 mb-2">Motivação</h3>
                    <p>
                        Este projeto foi desenvolvido com o objetivo de criar um dashboard interativo para explorar e visualizar os dados da produção acadêmica do <a href="https://www.uff.br/curso/biblioteconomia-e-documentacao/" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline font-medium">curso de Biblioteconomia e Documentação</a> e do <a href="https://ppgci-uff.com.br/" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline font-medium">programa de pós-graduação em Ciência da Informação</a> da <a href="https://www.uff.br/" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline font-medium">Universidade Federal Fluminense (UFF)</a>, disponíveis no repositório institucional. A ideia é transformar dados brutos em insights claros e acessíveis, permitindo que alunos, professores e pesquisadores analisem tendências, identifiquem áreas de pesquisa e compreendam a evolução do conhecimento na área.
                    </p>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-blue-700 mb-2">Autoria</h3>
                    <p>
                        O projeto foi idealizado e desenvolvido por <a href="https://www.linkedin.com/in/rafaelvillaverde/" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline font-medium">Rafael Villa Verde</a>, discente do curso de Bacharel em Biblioteconomia e Documentação da UFF. Você pode encontrar mais sobre o trabalho dele e entrar em contato através dos seguintes links:
                    </p>
                    <div class="mt-3 flex flex-wrap gap-4">
                        <a href="https://www.linkedin.com/in/rafaelvillaverde/" target="_blank" rel="noopener noreferrer" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">LinkedIn</a>
                        <a href="https://github.com/hafael" target="_blank" rel="noopener noreferrer" class="bg-gray-800 text-white px-4 py-2 rounded-md hover:bg-gray-900 transition-colors">GitHub Pessoal</a>
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-blue-700 mb-2">Código-Fonte e Licença</h3>
                    <p>
                        Este é um projeto de código aberto e todo o código-fonte está disponível para consulta e contribuição no <a href="https://github.com/hafael/ri-uff-insights" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline font-medium">repositório no GitHub</a>. O projeto é distribuído sob os termos da <a href="https://github.com/hafael/ri-uff-insights/blob/main/LICENSE" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline font-medium">Licença MIT</a>, que permite o uso, a modificação e a distribuição do software com poucas restrições.
                    </p>
                </div>
            </div>
        </section>

        <!-- Rodapé com informações de geração -->
        <footer class="mt-12 pt-6 border-t text-center text-sm text-gray-500 no-print">
            <p>Relatório gerado automaticamente a partir do dataset do Repositório Institucional UFF</p>
            <p class="mt-1">Processado em <span id="data-processamento"></span></p>
        </footer>

        <!-- Modal para detalhes do trabalho -->
        <div id="modal-trabalho" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-white rounded-lg shadow-xl w-11/12 md:w-3/4 lg:w-2/3 max-h-screen overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center pb-4 border-b">
                        <h3 id="modal-titulo" class="text-xl font-semibold"></h3>
                        <button id="fechar-modal" class="text-gray-500 hover:text-gray-700">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <div id="modal-conteudo" class="py-4">
                        <!-- Conteúdo será preenchido via JavaScript -->
                    </div>
                    <div class="pt-4 border-t flex justify-end space-x-2">
                        <button id="btn-url" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                            </svg>
                            Acessar Publicação
                        </button>
                        <button id="btn-download" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                            Download PDF
                        </button>
                        <button id="btn-copiar" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
                            </svg>
                            Copiar Referência
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Dados do JSON (exemplo reduzido para demonstração)
        const datasetFilePath = 'https://raw.githubusercontent.com/hafael/ri-uff-insights/refs/heads/main/dataset.json'; // Caminho para o arquivo JSON
        let datasetDate = '2025-08-30'; // Data do dataset (pode ser extraída do JSON se disponível)
        let data = [];

        // Variáveis globais
        let trabalhosProcessados = [];
        let orientadoresMap = new Map();
        let participacoesBancaMap = new Map();
        let autoresMap = new Map();
        let areasTematicas = new Set();
        let anos = new Set();
        let orientadoresSet = new Set();
        let palavrasChaveMap = new Map();
        let currentPage = 1;
        const itemsPerPage = 16;
        let filteredTrabalhos = [];
        let temasPorAno = new Map();
        let graficoEvolucaoTema = null;
        let graficoTemporalInstance = null;
        let graficoTimeToOnline = null;
        let graficoLicencas = null;
        let redeNetworkInstance = null;
        let mapaNetworkInstance = null;
        let temasMap = new Map();
        let hamburgerBtn = null;
        let mobileMenu = null;
        let mobileMenuBackdrop = null;
        let closeMenuBtn = null;
        let mobileMenuLinks = null;
        let trabalhosExibidos = [];
        let debounceTimer;
        let topicMap = {}; // Será preenchido dinamicamente
        let activeTopic = null;
        let graficoEntidadesOrg = null;
        let graficoEntidadesLoc = null;
        let graficoMetodologias = null;

        // --- FUNÇÃO PRINCIPAL DE CARREGAMENTO E INICIALIZAÇÃO ---
        async function iniciarAplicacao() {
            const loadingIndicator = document.getElementById('loading-indicator');
            const mainContainer = document.querySelector('.container');

            try {
                // Oculta o conteúdo principal para evitar mostrar a página vazia
                mainContainer.style.visibility = 'hidden';

                // Inicializa a lógica do banner de cookies PRIMEIRO
                setupCookieConsent();

                // 1. BUSCAR OS DADOS DO ARQUIVO JSON
                const response = await fetch(datasetFilePath);
                
                // Verifica se o arquivo foi encontrado e o servidor respondeu corretamente
                if (!response.ok) {
                    throw new Error(`Erro de rede: ${response.status} - ${response.statusText}`);
                }
                
                // Converte a resposta em um objeto JavaScript
                data = await response.json();

                // 2. SE OS DADOS FORAM CARREGADOS, EXECUTA TODAS AS FUNÇÕES DE RENDERIZAÇÃO
                
                // Data atual
                const agora = new Date();
                document.getElementById('data-processamento').textContent = agora.toLocaleString('pt-BR');
                document.getElementById('current-date').textContent = agora.toLocaleString('pt-BR');
                document.getElementById('dataset-date').textContent = new Date(datasetDate).toLocaleDateString('pt-BR');
                
                // Processar dados
                //gerarTopicMapDinamico();
                gerarTopicMap();
                processarDados();
                processarDadosTemas();
                preencherFiltros();
                processarDadosMapaTematico();
                
                // Renderizar componentes
                preparaMenuResponsivo();
                renderizarFiltrosDeTopico(); // NOVO: Renderiza os botões de tópico

                // Adicionar Event Listeners
                configurarEventListeners();

                // Primeira renderização com todos os dados
                atualizarDashboard(trabalhosProcessados);

                // 3. ESCONDE O INDICADOR DE CARREGAMENTO E MOSTRA O CONTEÚDO
                loadingIndicator.style.display = 'none';
                mainContainer.style.visibility = 'visible';

            } catch (error) {
                // 4. SE OCORRER UM ERRO, MOSTRA UMA MENSAGEM AMIGÁVEL
                console.error('Falha ao carregar ou processar os dados:', error);
                loadingIndicator.innerHTML = `
                    <div class="text-center text-red-600">
                        <p class="text-lg font-semibold">Ocorreu um erro ao carregar os dados.</p>
                        <p class="text-sm mt-2">Verifique o console do navegador para mais detalhes e certifique-se de que o arquivo 'dados.json' está acessível.</p>
                    </div>
                `;
            }
        }

        /**
         * Função central que recalcula e renderiza todos os componentes do dashboard
         * com base em um determinado conjunto de dados (filtrado ou completo).
         */
         function atualizarDashboard(trabalhos) {
            // Limpa os mapas de contagem para recalcular
            orientadoresMap.clear();
            autoresMap.clear();
            palavrasChaveMap.clear();
            temasPorAno.clear();

            // Recalcula os mapas e contagens com base nos dados fornecidos
            trabalhos.forEach(trabalho => {
                // Contagem de palavras-chave para a nuvem
                trabalho.todasPalavrasChave.forEach(palavra => {
                    const count = palavrasChaveMap.get(palavra) || 0;
                    palavrasChaveMap.set(palavra, count + 1);
                });

                // Contagem para o índice de orientadores
                if (trabalho.orientadorNormalizado) {
                    if (!orientadoresMap.has(trabalho.orientadorNormalizado)) {
                        orientadoresMap.set(trabalho.orientadorNormalizado, { tcc: 0, dissertacao: 0, tese: 0, bancas: new Set() });
                    }
                    const orientador = orientadoresMap.get(trabalho.orientadorNormalizado);
                    if (trabalho.tipo === 'TCC') orientador.tcc++;
                    else if (trabalho.tipo === 'Dissertação') orientador.dissertacao++;
                    else if (trabalho.tipo === 'Tese') orientador.tese++;
                }

                // Contagem para o índice de autores
                if (trabalho.autorNormalizado) {
                     if (!autoresMap.has(trabalho.autorNormalizado)) {
                        autoresMap.set(trabalho.autorNormalizado, { tcc: 0, dissertacao: 0, tese: 0 });
                    }
                    const autor = autoresMap.get(trabalho.autorNormalizado);
                    if (trabalho.tipo === 'TCC') autor.tcc++;
                    else if (trabalho.tipo === 'Dissertação') autor.dissertacao++;
                    else if (trabalho.tipo === 'Tese') autor.tese++;
                }

                // Contagem para a evolução temática
                const ano = trabalho.ano;
                if (ano !== 'Não informado') {
                    trabalho.todasPalavrasChave.forEach(palavra => {
                        if (!temasPorAno.has(palavra)) temasPorAno.set(palavra, new Map());
                        const mapaAnos = temasPorAno.get(palavra);
                        const contagemAtual = mapaAnos.get(ano) || 0;
                        mapaAnos.set(ano, contagemAtual + 1);
                    });
                }
            });

            // Re-renderiza todos os componentes do dashboard
            renderizarDadosGerais(trabalhos); // Passa os trabalhos para os totais
            renderizarTrabalhos(); // Já usa a variável global 'filteredTrabalhos'
            renderizarPaginacao();
            //renderizarIndiceOrientadores();
            aplicarBuscaOrientadores();
            //renderizarIndiceAutores();
            aplicarBuscaAutores();
            renderizarEvolucaoAcademica();
            gerarNuvemPalavras();
            //renderizarRedeColaboracao(trabalhos); // Bloqueia o inicio automático
            //renderizarMapaDaCiencia(trabalhos); // Bloqueia o inicio automático
            renderizarEvolucaoTemas();
            renderizarJornadaAutor(); // Já usa o 'autoresMap' recalculado
            renderizarIndicadoresInfometricos(trabalhos);
            renderizarGraficosEntidades(trabalhos);
            renderizarGraficoMetodologias(trabalhos);
            renderizarFiltrosAtivos(); // Renderiza os chips de filtros
            //renderizarMapaTematicoTabela();
            aplicarBuscaMapaTematico();
            popularFiltroMapaTematico();
        }

        // --- FUNÇÃO PARA CONFIGURAR OS EVENT LISTENERS ---
        function configurarEventListeners() {

            // --- LÓGICA PARA A NOVA BARRA DE NAVEGAÇÃO ---
            hamburgerBtn.addEventListener('click', toggleMenu);
            closeMenuBtn.addEventListener('click', toggleMenu);
            //mobileMenuBackdrop.addEventListener('click', toggleMenu);
            // Fecha o menu ao clicar em um link (melhora a experiência do usuário)
            mobileMenuLinks.forEach(link => {
                link.addEventListener('click', toggleMenu);
            });

            // Efeito de sombra na navegação ao rolar
            const mainNav = document.getElementById('main-nav');

            window.addEventListener('scroll', () => {
                if (window.scrollY > 10) {
                    mainNav.classList.add('shadow-md');
                } else {
                    mainNav.classList.remove('shadow-md');
                }
            });

            // --- FIM LÓGICA PARA A NOVA BARRA DE NAVEGAÇÃO ---

            // Listener para o campo de busca com Debounce
            const campoBusca = document.getElementById('filtro-busca-textual');
            campoBusca.addEventListener('input', () => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    aplicarBuscaLocal(); // AGORA CHAMA A FUNÇÃO DE BUSCA LOCAL
                }, 500);
            });

            // Listeners para as novas buscas com Debounce
            const campoBuscaOrientadores = document.getElementById('busca-orientadores');
            campoBuscaOrientadores.addEventListener('input', () => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    aplicarBuscaOrientadores();
                }, 400); // 400ms de atraso
            });

            const campoBuscaAutores = document.getElementById('busca-autores');
            campoBuscaAutores.addEventListener('input', () => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    aplicarBuscaAutores();
                }, 400); // 400ms de atraso
            });

            const campoBuscaMapaTematico = document.getElementById('busca-mapa-tematico');
            campoBuscaMapaTematico.addEventListener('input', () => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    aplicarBuscaMapaTematico();
                }, 400); // 400ms de atraso
            });

            const btnExportPdf = document.getElementById('btn-export-pdf');
            if (btnExportPdf) {
                btnExportPdf.addEventListener('click', exportarParaPDF);
            }
            document.getElementById('btn-aplicar-filtros').addEventListener('click', aplicarFiltros);
            document.getElementById('btn-limpar-filtros').addEventListener('click', limparFiltros);
            document.getElementById('fechar-modal').addEventListener('click', fecharModal);
            document.getElementById('modal-trabalho').addEventListener('click', (e) => {
                if (e.target.id === 'modal-trabalho') fecharModal();
            });
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') fecharModal();
            });

            // Lógica para o botão Voltar ao Topo
            const btnVoltarTopo = document.getElementById('btn-voltar-topo');
            window.addEventListener('scroll', () => {
                if (window.pageYOffset > 300) { // Mostra o botão depois de rolar 300px
                    btnVoltarTopo.style.display = 'block';
                } else {
                    btnVoltarTopo.style.display = 'none';
                }
            });
            btnVoltarTopo.addEventListener('click', () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
            
            // Mapa temático
            document.getElementById('filtro-mapa-tema').addEventListener('change', (e) => {
                exibirDetalhesTema(e.target.value);
            });

            configurarControlesRedeColaboracao();
            configurarControlesMapaCiencia();
        }
    
        // --- LÓGICA PARA A NOVA BARRA DE NAVEGAÇÃO ---
        function preparaMenuResponsivo() {
            hamburgerBtn = document.getElementById('hamburger-btn');
            mobileMenu = document.getElementById('mobile-menu');
            //mobileMenuBackdrop = document.getElementById('mobile-menu-backdrop');
            closeMenuBtn = document.getElementById('close-menu-btn');
            mobileMenuLinks = document.querySelectorAll('.mobile-menu-link');
        }

        // NOVA VERSÃO da função toggleMenu que controla a NAV principal
        function toggleMenu() {
            const mainNav = document.getElementById('main-nav');
            mainNav.classList.toggle('menu-aberto');

            // Controla o scroll do body para evitar rolagem da página por trás do menu
            const isAberto = mainNav.classList.contains('menu-aberto');
            document.body.style.overflow = isAberto ? 'hidden' : '';
        }


        /**
         * NOVA FUNÇÃO: Normaliza o nome da licença a partir da URL ou texto completo.
         * @param {string} licenseString A string da licença do dataset.
         * @returns {string} O nome normalizado da licença (ex: "CC BY-SA").
         */
         function normalizarLicenca(licenseString) {
            if (!licenseString) {
                return 'Não informada';
            }
            // Converte para minúsculas para facilitar a busca
            const lowerCaseLicense = licenseString.toLowerCase();

            // A ordem é importante: do mais específico para o mais genérico
            if (lowerCaseLicense.includes('by-nc-nd')) return 'CC BY-NC-ND';
            if (lowerCaseLicense.includes('by-nc-sa')) return 'CC BY-NC-SA';
            if (lowerCaseLicense.includes('by-nc')) return 'CC BY-NC';
            if (lowerCaseLicense.includes('by-sa')) return 'CC BY-SA';
            if (lowerCaseLicense.includes('by-nd')) return 'CC BY-ND';
            if (lowerCaseLicense.includes('/by/')) return 'CC BY'; // Busca o "BY" simples em URLs
            
            // Se não encontrar um padrão conhecido, agrupa como "Outra"
            return 'Outra';
        }

        /**
         * Normaliza uma string para busca, removendo acentos, convertendo para minúsculas e removendo espaços excessivos.
         * @param {string} str A string a ser normalizada.
         * @returns {string} A string normalizada.
         */
        function normalizarStringParaBusca(str) {
            if (!str || typeof str !== 'string') return '';
            return str
                .toLowerCase() // Converte para caixa baixa
                .normalize("NFD") // Separa os caracteres dos acentos
                .replace(/[\u0300-\u036f]/g, "") // Remove os acentos (diacríticos)
                .trim(); // Remove espaços no início e fim
        }

        // Normalização de nomes
        /**
         * Normaliza um nome aplicando um mapa de correções estáticas e regras de limpeza.
         * Esta função é segura e não causa loops.
         * @param {string} nome O nome a ser normalizado.
         * @returns {string} O nome normalizado.
         */
         function normalizarNome(nome) {
            if (!nome || typeof nome !== 'string') return '';

            // Mapa de correções conhecidas e estáticas. Adicione outras variações aqui se necessário.
            const mapeamentosEstaticos = {
                "Cordeiro , Rosa Inês de Novais": "Cordeiro, Rosa Inês de Novais",
                "Freitas, Lídia Silva de": "Freitas, Lídia Silvia de",
                "Fujita, Mariângela Spotti": "Fujita, Mariângela Spotti Lopes",
                "Juvêncio, Carlos Henrique": "Silva, Carlos Henrique Juvêncio da",
                "Sousa, Renato Tarciso Barbosa de": "Sousa, Renato Tarciso de",
                "Souza, Joice Cleide Cardoso Ennes de": "Souza, Jóice Cleide Cardoso Ennes de",
                "Souza, Joice Cleide Cardoso Ennes de": "Souza, Jóice Cleide Cardoso Ennes de",
                "Ennes, Joice Cardoso": "Souza, Jóice Cleide Cardoso Ennes de",
                "Vogel, Michely Jabala Mamede": "Vogel, Michely Mamede Jabala",
                "Bossi, Marcia J.": "Bossy, Marcia Jurkiewicz",
                "Badini, Sandra Bordes": "Badini, Sandra Borges",
                "Rebel, Sandra Lucia": "Gomes, Sandra Lúcia Rebel",
                "Schmidit, Clarissa Moreira dos Santos": "Schmidt, Clarissa Moreira dos Santos"
            };
            
            // Aplica mapeamento estático primeiro, se existir
            if (mapeamentosEstaticos[nome.trim()]) {
                return mapeamentosEstaticos[nome.trim()];
            }
            
            // Aplica regras gerais de limpeza de texto
            return nome
                .replace(/\s+/g, ' ') // Remove espaços duplicados
                .replace(/ ,/g, ',')   // Remove espaço antes da vírgula
                .replace(/, /g, ', ')  // Garante um espaço padrão depois da vírgula
                .trim();               // Remove espaços no início e no fim
        }

        // Identificar e relatar nomes duplicados/variantes (atualizada)
        /**
         * Coleta todos os nomes do dataset, aplica a normalização e retorna um mapa
         * com os nomes normalizados e suas respectivas variações encontradas.
         * @returns {Map<string, Set<string>>} Um mapa onde a chave é o nome normalizado e o valor é um conjunto de variações.
         */
         function identificarVariantesDeNomes() {
            const todosOsNomes = new Set();
            const variantesEncontradas = new Map();

            // Passo 1: Coletar todos os nomes únicos do dataset bruto para evitar processamento repetido.
            data.forEach(trabalho => {
                if (trabalho.author) todosOsNomes.add(trabalho.author);
                if (trabalho.advisor) todosOsNomes.add(trabalho.advisor);
                if (trabalho.board_members) {
                    trabalho.board_members.forEach(membro => {
                        if (membro) todosOsNomes.add(membro);
                    });
                }
            });

            // Passo 2: Processar cada nome único para encontrar e agrupar as variantes.
            todosOsNomes.forEach(nomeOriginal => {
                const nomeNormalizado = normalizarNome(nomeOriginal);

                // Se a versão normalizada é diferente da original, consideramos a original como uma variante.
                if (nomeNormalizado !== nomeOriginal) {
                    // Agrupa as variantes sob o nome normalizado.
                    if (!variantesEncontradas.has(nomeNormalizado)) {
                        variantesEncontradas.set(nomeNormalizado, new Set());
                    }
                    variantesEncontradas.get(nomeNormalizado).add(nomeOriginal);
                }
            });

            return variantesEncontradas;
        }

        // Renderizar tabela de normalização de nomes
        // Renderizar tabela de normalização de nomes (VERSÃO ATUALIZADA PARA RESPONSIVIDADE)
        function renderizarNormalizacaoNomes() {
            const tabela = document.getElementById('tabela-normalizacao');
            tabela.innerHTML = '';
            
            const variantes = identificarVariantesDeNomes(); 
            
            if (variantes.size === 0) {
                tabela.innerHTML = `
                    <tr>
                        <td colspan="3" class="px-6 py-4 text-center text-gray-500">
                            Nenhuma variação de nome foi identificada para normalização.
                        </td>
                    </tr>
                `;
                return;
            }
            
            const participacoes = new Map();
            
            trabalhosProcessados.forEach(trabalho => {
                if (trabalho.author) {
                    const nomeNorm = normalizarNome(trabalho.author);
                    if (!participacoes.has(nomeNorm)) participacoes.set(nomeNorm, new Set());
                    participacoes.get(nomeNorm).add('Autor');
                }
                if (trabalho.advisor) {
                    const nomeNorm = normalizarNome(trabalho.advisor);
                    if (!participacoes.has(nomeNorm)) participacoes.set(nomeNorm, new Set());
                    participacoes.get(nomeNorm).add('Orientador');
                }
                if (trabalho.bancaNormalizada) {
                    trabalho.bancaNormalizada.forEach(membro => {
                        if (membro) {
                            const nomeNorm = normalizarNome(membro);
                            if (!participacoes.has(nomeNorm)) participacoes.set(nomeNorm, new Set());
                            participacoes.get(nomeNorm).add('Membro de Banca');
                        }
                    });
                }
            });
            
            const nomesOrdenados = Array.from(variantes.entries()).sort((a, b) => 
                a[0].localeCompare(b[0])
            );
            
            nomesOrdenados.forEach(([nomeNormalizado, variantesSet]) => {
                const row = document.createElement('tr');
                const tiposParticipacao = participacoes.get(nomeNormalizado) || new Set();
                const tiposArray = Array.from(tiposParticipacao);
                
                // Adição dos atributos data-label para responsividade
                row.innerHTML = `
                    <td class="px-6 py-4 font-medium text-blue-800">${nomeNormalizado}</td>
                    <td class="px-6 py-4" data-label="Variações Encontradas:">
                        <ul class="list-disc list-inside">
                            ${Array.from(variantesSet).map(variante => 
                                `<li class="text-red-600">${variante}</li>`
                            ).join('')}
                        </ul>
                    </td>
                    <td class="px-6 py-4" data-label="Tipo:">
                        ${tiposArray.map(tipo => 
                            `<span class="inline-block bg-gray-100 px-2 py-1 rounded text-xs font-medium mr-1">${tipo}</span>`
                        ).join('')}
                    </td>
                `;
                tabela.appendChild(row);
            });
        }

        // Extrair ano da data
        function extrairAno(dateString) {
            if (!dateString) return 'Não informado';
            
            // Usa o 'g' no regex para encontrar TODAS as ocorrências de anos com 4 dígitos.
            const anoMatches = dateString.match(/\b(19|20)\d{2}\b/g);

            // Se encontrar múltiplos anos, o último é o correto.
            // Se encontrar apenas um, usa esse. Se não encontrar, retorna 'Não informado'.
            return anoMatches ? anoMatches[anoMatches.length - 1] : 'Não informado';
        }

        // MODIFICADA: Apenas processa os dados brutos uma vez
        function processarDados() {
            trabalhosProcessados = data.map(trabalho => {
                const autorNormalizado = normalizarNome(trabalho.author);
                const orientadorNormalizado = normalizarNome(trabalho.advisor);
                const bancaNormalizada = trabalho.board_members ? trabalho.board_members.map(normalizarNome) : [];
                //const ano = extrairAno(trabalho.date_issued || trabalho.date_available);

                // Prioriza o campo 'degree_date'. Se não existir, usa a lógica anterior como fallback.
                const ano = trabalho.degree_date || extrairAno(trabalho.date_issued || trabalho.date_available);
                
                let tipo = 'Outro';
                if (trabalho.collection_name.includes('TCC') || (trabalho.degree_level && trabalho.degree_level.includes('graduação'))) {
                    tipo = 'TCC';
                } else if (trabalho.collection_name.includes('Disserta') || (trabalho.degree_level && trabalho.degree_level.includes('Mestrado'))) {
                    tipo = 'Dissertação';
                } else if (trabalho.collection_name.includes('Tese') || (trabalho.degree_level && trabalho.degree_level.includes('Doutorado'))) {
                    tipo = 'Tese';
                }
                
                const todasPalavrasChave = [
                    ...(trabalho.keywords || []),
                    ...(trabalho.descriptors || []),
                    ...(trabalho.additional_keywords || []),
                    ...(trabalho.auto_keywords || [])
                ];

                // Popula os sets para os filtros (isso só precisa ser feito uma vez)
                if (trabalho.descriptors && trabalho.descriptors.length > 0) {
                    trabalho.descriptors.forEach(area => areasTematicas.add(area));
                }
                if (ano !== 'Não informado') anos.add(ano);
                if (orientadorNormalizado) orientadoresSet.add(orientadorNormalizado);
                
                return {
                    ...trabalho, autorNormalizado, orientadorNormalizado, bancaNormalizada, ano, tipo, todasPalavrasChave
                };
            });
            
            trabalhosProcessados.sort((a, b) => {
                if (a.ano === 'Não informado') return 1; if (b.ano === 'Não informado') return -1;
                return parseInt(b.ano) - parseInt(a.ano);
            });
            
            // Calcula o total de participações em bancas para cada membro
            participacoesBancaMap.clear(); // Limpa para garantir contagem fresca
            
            trabalhosProcessados.forEach(trabalho => {
                if (trabalho.bancaNormalizada) {
                    trabalho.bancaNormalizada.forEach(membro => {
                        if (membro) { // Garante que o membro não seja nulo ou vazio
                            const count = participacoesBancaMap.get(membro) || 0;
                            participacoesBancaMap.set(membro, count + 1);
                        }
                    });
                }
            });

            filteredTrabalhos = [...trabalhosProcessados];
            trabalhosExibidos = [...trabalhosProcessados];

            renderizarNormalizacaoNomes();
        }
    
        // Renderizar dados gerais
        // MODIFICADA E CORRIGIDA: Gráfico temporal agora é reativo e não causa erro.
        function renderizarDadosGerais(trabalhos) {
            // --- Parte 1: Renderiza os totais (sem alterações) ---
            document.getElementById('total-trabalhos').textContent = trabalhos.length;
            
            const tipoCount = { 'TCC': 0, 'Dissertação': 0, 'Tese': 0, 'Outro': 0 };
            trabalhos.forEach(trabalho => { tipoCount[trabalho.tipo]++; });
            
            const tipoTrabalhosEl = document.getElementById('tipo-trabalhos');
            tipoTrabalhosEl.innerHTML = '';
            for (const [tipo, count] of Object.entries(tipoCount)) {
                if (count > 0) {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center text-sm';
                    li.innerHTML = `<span>${tipo}:</span> <span class="font-bold text-lg">${count}</span>`;
                    tipoTrabalhosEl.appendChild(li);
                }
            }

            // --- Parte 2: Lógica do Gráfico Temporal (Corrigida e Reativa) ---

            // 1. Destroi a instância anterior do gráfico, se ela existir.
            if (graficoTemporalInstance) {
                graficoTemporalInstance.destroy();
            }

            // 2. Agrupa e conta os trabalhos por ano a partir dos dados (filtrados ou não)
            const countsPorAno = trabalhos.reduce((acc, trabalho) => {
                if (trabalho.ano !== 'Não informado') {
                    acc[trabalho.ano] = (acc[trabalho.ano] || 0) + 1;
                }
                return acc;
            }, {});

            // 3. Prepara os dados para o Chart.js
            const anosLabels = Object.keys(countsPorAno).sort();
            const dadosContagem = anosLabels.map(ano => countsPorAno[ano]);

            // 4. Cria a nova instância do gráfico
            const ctx = document.getElementById('grafico-temporal').getContext('2d');
            graficoTemporalInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: anosLabels,
                    datasets: [{
                        label: 'Trabalhos por Ano',
                        data: dadosContagem,
                        backgroundColor: 'rgba(59, 130, 246, 0.5)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: { display: false } // O título já está na seção
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });
        }

        /**
         * Mostra visualmente quais filtros estão ativos.
         */
         function renderizarFiltrosAtivos() {
            const container = document.getElementById('filtros-ativos-container');
            container.innerHTML = '';
            
            const filtros = {
                'Área': document.getElementById('filtro-area').value,
                'Ano': document.getElementById('filtro-ano').value,
                'Orientador': document.getElementById('filtro-orientador').value,
                'Tipo': document.getElementById('filtro-tipo').value,
                'Metodologia': document.getElementById('filtro-metodologia').value // NOVO
            };

            if (activeTopic !== null && topicMap[activeTopic]) {
                filtros['Tópico'] = topicMap[activeTopic];
            }

            const temFiltros = Object.values(filtros).some(v => v !== '');

            if (!temFiltros) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'block';
            let chipsHTML = '<div class="flex flex-wrap items-center gap-2"><span class="text-sm font-medium text-gray-600">Filtros Ativos:</span>';

            for (const [key, value] of Object.entries(filtros)) {
                if (value) {
                    const filtroId = key === 'Tópico' ? 'filtro-topic' : `filtro-${key.toLowerCase()}`;
                    chipsHTML += `
                        <span class="inline-flex items-center bg-blue-100 text-blue-800 text-sm font-semibold pl-3 pr-1 py-1 rounded-full">
                            ${value}
                            <button class="ml-2 flex-shrink-0 bg-blue-200 hover:bg-blue-300 rounded-full h-5 w-5 flex items-center justify-center" data-filtro-id="${filtroId}">
                                &times;
                            </button>
                        </span>
                    `;
                }
            }
            chipsHTML += `</div>`;
            container.innerHTML = chipsHTML;

            container.querySelectorAll('button').forEach(button => {
                button.addEventListener('click', () => {
                    const filtroId = button.dataset.filtroId;
                    
                    if (filtroId === 'filtro-topic') {
                        activeTopic = null;
                        document.querySelectorAll('#topic-filters button').forEach(btn => {
                            btn.classList.add('bg-white', 'text-gray-700', 'border-gray-300');
                            btn.classList.remove('bg-blue-600', 'text-white', 'border-blue-600');
                        });
                    } else {
                        document.getElementById(filtroId).value = '';
                    }
                    
                    aplicarFiltros();
                });
            });
        }
    
        // Preencher filtros
        function preencherFiltros() {
            const areasTematicas = new Set();
            const anos = new Set();
            const orientadoresSet = new Set();
            const metodologias = new Set(); // NOVO: Set para metodologias

            trabalhosProcessados.forEach(trabalho => {
                if (trabalho.descriptors && trabalho.descriptors.length > 0) {
                    trabalho.descriptors.forEach(area => areasTematicas.add(area));
                }
                if (trabalho.ano !== 'Não informado') anos.add(trabalho.ano);
                if (trabalho.orientadorNormalizado) orientadoresSet.add(trabalho.orientadorNormalizado);
                
                // NOVO: Popula o Set de metodologias
                if (trabalho.methodologies && trabalho.methodologies.length > 0) {
                    trabalho.methodologies.forEach(metodo => metodologias.add(metodo));
                }
            });

            // Áreas temáticas (lógica existente)
            const filtroArea = document.getElementById('filtro-area');
            Array.from(areasTematicas).sort().forEach(area => {
                const option = document.createElement('option');
                option.value = area;
                option.textContent = area;
                filtroArea.appendChild(option);
            });
            
            // Anos (lógica existente)
            const filtroAno = document.getElementById('filtro-ano');
            Array.from(anos).sort((a, b) => b - a).forEach(ano => {
                const option = document.createElement('option');
                option.value = ano;
                option.textContent = ano;
                filtroAno.appendChild(option);
            });
            
            // Orientadores (lógica existente)
            const filtroOrientador = document.getElementById('filtro-orientador');
            Array.from(orientadoresSet).sort().forEach(orientador => {
                const option = document.createElement('option');
                option.value = orientador;
                option.textContent = orientador;
                filtroOrientador.appendChild(option);
            });

            // NOVO: Popula o select de metodologias
            const filtroMetodologia = document.getElementById('filtro-metodologia');
            Array.from(metodologias).sort().forEach(metodo => {
                const option = document.createElement('option');
                option.value = metodo;
                option.textContent = metodo;
                filtroMetodologia.appendChild(option);
            });
        }
    
        // Aplicar filtros
        // MODIFICADA: Agora apenas aplica o filtro e chama a atualização
        function aplicarFiltros() {
            resetarVisualizacoesDeGrafos();

            const area = document.getElementById('filtro-area').value;
            const ano = document.getElementById('filtro-ano').value;
            const orientador = document.getElementById('filtro-orientador').value;
            const tipo = document.getElementById('filtro-tipo').value;
            const metodologia = document.getElementById('filtro-metodologia').value; // NOVO

            // Filtra a partir da lista mestra
            filteredTrabalhos = trabalhosProcessados.filter(trabalho => {
                const topicMatch = activeTopic === null || (trabalho.topic && trabalho.topic === activeTopic);
                
                // NOVO: Adiciona a condição de filtro por metodologia
                const metodologiaMatch = !metodologia || (trabalho.methodologies && trabalho.methodologies.includes(metodologia));

                return topicMatch &&
                    metodologiaMatch && // <-- CONDIÇÃO ADICIONADA
                    (!area || (trabalho.descriptors && trabalho.descriptors.includes(area))) &&
                    (!ano || trabalho.ano === ano) &&
                    (!orientador || trabalho.orientadorNormalizado === orientador) &&
                    (!tipo || trabalho.tipo === tipo);
            });

            document.getElementById('filtro-busca-textual').value = '';
            trabalhosExibidos = [...filteredTrabalhos];
            currentPage = 1;
            atualizarDashboard(filteredTrabalhos);
        }
    
        // Limpar filtros
        // MODIFICADA: Limpa os filtros e chama a atualização com os dados completos
        function limparFiltros() {
            resetarVisualizacoesDeGrafos();
            document.getElementById('filtro-area').value = '';
            document.getElementById('filtro-ano').value = '';
            document.getElementById('filtro-orientador').value = '';
            document.getElementById('filtro-tipo').value = '';
            document.getElementById('filtro-metodologia').value = ''; // NOVO
            document.getElementById('filtro-busca-textual').value = '';
            document.getElementById('busca-orientadores').value = '';
            document.getElementById('busca-autores').value = '';
            document.getElementById('busca-mapa-tematico').value = '';
            
            activeTopic = null;
            document.querySelectorAll('#topic-filters button').forEach(btn => {
                btn.classList.add('bg-white', 'text-gray-700', 'border-gray-300');
                btn.classList.remove('bg-blue-600', 'text-white', 'border-blue-600');
            });
            
            filteredTrabalhos = [...trabalhosProcessados];
            trabalhosExibidos = [...trabalhosProcessados]; // NOVO: Garante que a lista de exibição também seja resetada
            currentPage = 1;
            atualizarDashboard(trabalhosProcessados);
        }

        /**
         * Filtra a lista de trabalhos JÁ FILTRADA (filteredTrabalhos)
         * com base no termo de busca textual e atualiza APENAS a lista e a paginação.
         * UTILIZA NORMALIZAÇÃO DE STRING PARA IGNORAR ACENTOS E CAIXA.
         */
         function aplicarBuscaLocal() {
            // A busca agora usa a função de normalização completa
            const termoBusca = normalizarStringParaBusca(document.getElementById('filtro-busca-textual').value);

            if (!termoBusca) {
                // Se a busca está vazia, mostra todos os resultados do filtro global
                trabalhosExibidos = [...filteredTrabalhos];
            } else {
                // Filtra a lista `filteredTrabalhos` aplicando a normalização em cada campo
                trabalhosExibidos = filteredTrabalhos.filter(trabalho => {
                    // MODIFICAÇÃO: A busca agora inclui o resumo (abstract) e todas as palavras-chave
                    return (trabalho.title && normalizarStringParaBusca(trabalho.title).includes(termoBusca)) ||
                        (trabalho.autorNormalizado && normalizarStringParaBusca(trabalho.autorNormalizado).includes(termoBusca)) ||
                        (trabalho.orientadorNormalizado && normalizarStringParaBusca(trabalho.orientadorNormalizado).includes(termoBusca)) ||
                        (trabalho.abstract && normalizarStringParaBusca(trabalho.abstract).includes(termoBusca)) ||
                        (trabalho.todasPalavrasChave && trabalho.todasPalavrasChave.some(kw => normalizarStringParaBusca(kw).includes(termoBusca)));
                });
            }

            currentPage = 1;
            renderizarTrabalhos();
            renderizarPaginacao();
        }
    
        // Renderizar trabalhos (VERSÃO MELHORADA)
        // Renderizar trabalhos (VERSÃO SEM TEXTO DE CONTAGEM)
        function renderizarTrabalhos() {
            const listaTrabalhos = document.getElementById('lista-trabalhos');
            // A linha que controlava o 'infoTrabalhosEl' foi removida daqui.
            
            listaTrabalhos.innerHTML = '';

            const totalTrabalhos = trabalhosExibidos.length;
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, totalTrabalhos);

            if (totalTrabalhos === 0) {
                // Remove a info de trabalhos se não houver resultados
                document.getElementById('info-trabalhos').innerHTML = '';
                listaTrabalhos.innerHTML = `<p class="text-center text-gray-500 col-span-full">Nenhum trabalho encontrado para os filtros selecionados.</p>`;
                return;
            }
            
            // O texto informativo não é mais definido aqui.
            
            listaTrabalhos.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 xl:grid-cols-2 gap-6';

            for (let i = startIndex; i < endIndex; i++) {
                const trabalho = trabalhosExibidos[i];
                const trabalhoEl = document.createElement('div');
                
                trabalhoEl.className = 'bg-white p-5 rounded-xl shadow-lg border border-gray-100 flex flex-col justify-between transition-all duration-300 hover:shadow-xl hover:border-blue-200 cursor-pointer';
                trabalhoEl.dataset.id = trabalho.id;
                
                let tipoLabel = '';
                let tipoCor = '';
                if (trabalho.tipo === 'TCC') {
                    tipoLabel = 'TCC';
                    tipoCor = 'bg-blue-100 text-blue-800';
                } else if (trabalho.tipo === 'Dissertação') {
                    tipoLabel = 'Dissertação';
                    tipoCor = 'bg-green-100 text-green-800';
                } else if (trabalho.tipo === 'Tese') {
                    tipoLabel = 'Tese';
                    tipoCor = 'bg-purple-100 text-purple-800';
                } else {
                    tipoLabel = 'Outro';
                    tipoCor = 'bg-gray-100 text-gray-800';
                }

                trabalhoEl.innerHTML = `
                    <div>
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-xs font-bold uppercase tracking-wider px-2 py-1 rounded-full ${tipoCor}">${tipoLabel}</span>
                            <span class="text-sm font-semibold text-gray-500">${trabalho.ano}</span>
                        </div>
                        <h3 class="text-lg font-bold text-gray-800 leading-tight mb-3">${trabalho.title}</h3>
                    </div>
                    <div>
                        <div class="border-t pt-3 mt-3 space-y-2 text-sm text-gray-600">
                            <div class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                                <span class="font-medium mr-1">Autor:</span>
                                <span class="truncate">${trabalho.autorNormalizado}</span>
                            </div>
                            <div class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283-.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                                <span class="font-medium mr-1">Orientador:</span>
                                <span class="truncate">${trabalho.orientadorNormalizado || 'Não informado'}</span>
                            </div>
                        </div>
                        <div class="mt-4">
                            ${trabalho.todasPalavrasChave.slice(0, 3).map(palavra => 
                                `<span class="inline-block bg-gray-100 rounded-full px-3 py-1 text-xs font-semibold text-gray-700 mr-1 mb-1">${palavra}</span>`
                            ).join('')}
                            ${trabalho.todasPalavrasChave.length > 3 ? `<span class="inline-block bg-gray-100 rounded-full px-3 py-1 text-xs font-semibold text-gray-700 mr-1 mb-1">+${trabalho.todasPalavrasChave.length - 3}</span>` : ''}
                        </div>
                    </div>
                `;
                
                trabalhoEl.addEventListener('click', () => {
                    abrirModal(trabalho);
                });
                
                listaTrabalhos.appendChild(trabalhoEl);
            }
        }
    
        // Renderizar paginação (VERSÃO FINAL ADAPTATIVA)
        function renderizarPaginacao() {
            const paginacaoContainer = document.getElementById('paginacao');
            const infoTrabalhosEl = document.getElementById('info-trabalhos');
            paginacaoContainer.innerHTML = '';
            infoTrabalhosEl.innerHTML = '';

            const totalTrabalhos = trabalhosExibidos.length;
            const totalPages = Math.ceil(totalTrabalhos / itemsPerPage);
            
            if (totalPages <= 1) return;

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, totalTrabalhos);

            // Adiciona a informação de contagem de itens
            infoTrabalhosEl.textContent = `Exibindo ${startIndex + 1} - ${endIndex} de ${totalTrabalhos} trabalhos.`;
            infoTrabalhosEl.className = 'text-center text-sm text-gray-600 mb-4';

            const buttonWrapper = document.createElement('div');
            buttonWrapper.className = 'flex justify-center items-center space-x-1';

            const createButton = (page, content, isDisabled = false, isResponsive = false) => {
                const element = (page !== null) ? document.createElement('button') : document.createElement('span');
                element.innerHTML = content;

                let classes = 'inline-flex items-center justify-center h-9 w-9 rounded-md text-sm font-medium transition-colors ';
                
                if (page !== null) { // É um botão clicável
                    classes += isDisabled 
                        ? 'text-gray-400 cursor-not-allowed' 
                        : 'text-gray-700 hover:bg-gray-100';
                    
                    if (page === currentPage) {
                        classes += ' bg-blue-600 text-white hover:bg-blue-700 border border-blue-600';
                    }
                    
                    if (!isDisabled) {
                        element.addEventListener('click', () => {
                            currentPage = page;
                            renderizarTrabalhos();
                            renderizarPaginacao();
                            document.getElementById('trabalhos').scrollIntoView({ behavior: 'smooth' });
                        });
                    }
                } else { // É um span (elipse)
                    classes += ' text-gray-500';
                }

                if (isResponsive) {
                    classes += ' hidden sm:inline-flex'; // Oculta em telas pequenas
                }

                element.className = classes;
                return element;
            };

            // Botões de navegação
            buttonWrapper.appendChild(createButton(1, '«', currentPage === 1));
            buttonWrapper.appendChild(createButton(currentPage - 1, '‹', currentPage === 1));

            // Lógica para gerar os números de página
            const pageRange = 1; // Quantos números mostrar antes/depois da página atual
            const pagesToShow = new Set();
            
            pagesToShow.add(1);
            pagesToShow.add(totalPages);

            for (let i = currentPage - pageRange; i <= currentPage + pageRange; i++) {
                if (i > 1 && i < totalPages) {
                    pagesToShow.add(i);
                }
            }
            
            const sortedPages = Array.from(pagesToShow).sort((a, b) => a - b);
            let lastPage = 0;

            sortedPages.forEach(page => {
                const isResponsiveNumber = Math.abs(page - currentPage) > 0 && page !== 1 && page !== totalPages;
                if (lastPage !== 0 && page > lastPage + 1) {
                    buttonWrapper.appendChild(createButton(null, '...', false, isResponsiveNumber));
                }
                buttonWrapper.appendChild(createButton(page, page, false, isResponsiveNumber));
                lastPage = page;
            });

            // Botões de navegação
            buttonWrapper.appendChild(createButton(currentPage + 1, '›', currentPage === totalPages));
            buttonWrapper.appendChild(createButton(totalPages, '»', currentPage === totalPages));

            paginacaoContainer.appendChild(buttonWrapper);
        }
    

        /**
         * NOVA FUNÇÃO AUXILIAR: Copia um texto para a área de transferência.
         */
         function copiarTextoParaClipboard(texto) {
            // Usa a API de Clipboard para uma cópia segura
            navigator.clipboard.writeText(texto)
                .then(() => {
                    alert('Referência copiada para a área de transferência!');
                })
                .catch(err => {
                    console.error('Erro ao copiar referência:', err);
                    alert('Não foi possível copiar a referência.');
                });
        }

        /**
         * FUNÇÃO ATUALIZADA: Reverte o agrupamento de campos, mantendo a referência integrada.
         */
         function abrirModal(trabalho) {
            const modal = document.getElementById('modal-trabalho');
            const modalTitulo = document.getElementById('modal-titulo');
            const modalConteudo = document.getElementById('modal-conteudo');
            
            modalTitulo.textContent = trabalho.title;
            
            // 1. Destaque de Entidades (lógica existente)
            const resumoDestacado = destacarEntidades(trabalho.abstract, trabalho.entities);
            let abstractContentHTML = resumoDestacado ? `<p class="text-justify">${resumoDestacado}</p>` : '<p>Resumo não disponível.</p>';

            // 2. Palavras-chave Interativas (lógica existente)
            const manualKeywords = new Set([...(trabalho.keywords || []), ...(trabalho.descriptors || []), ...(trabalho.additional_keywords || [])]);
            const autoKeywords = new Set(trabalho.auto_keywords || []);
            autoKeywords.forEach(kw => { if (manualKeywords.has(kw)) { autoKeywords.delete(kw); } });

            const manualKeywordsHTML = Array.from(manualKeywords).map(palavra => `<button onclick="buscarPorTermo('${escapeRegExp(palavra.replace(/'/g, "\\'"))}')" class="keyword-interactive inline-block bg-gray-100 rounded-full px-3 py-1 text-xs font-semibold text-gray-700 border">${palavra}</button>`).join('');
            const autoKeywordsHTML = Array.from(autoKeywords).map(palavra => `<button onclick="buscarPorTermo('${escapeRegExp(palavra.replace(/'/g, "\\'"))}')" title="Palavra-chave extraída automaticamente" class="keyword-interactive inline-block bg-gray-100 rounded-full px-3 py-1 text-xs font-semibold text-gray-600 border border-dashed">${palavra}</button>`).join('');
            const keywordsHTML = manualKeywordsHTML + autoKeywordsHTML;

            // 3. Trabalhos Semelhantes (lógica existente)
            const similarDocsHTML = (trabalho.similar_docs || []).map(similarId => { const similarDoc = trabalhosProcessados.find(t => t.id === similarId); return similarDoc ? `<li><button onclick="abrirModalPorId('${similarDoc.id}')">${similarDoc.title}</button></li>` : ''; }).join('');

            // NOVO: 4. Relações Conceituais
            const relationshipsHTML = (trabalho.relationships && trabalho.relationships.length > 0)
                ? trabalho.relationships.map(([sujeito, verbo, objeto]) => 
                    `<li class="flex items-start"><span class="capitalize font-medium text-gray-900">${sujeito}</span><span class="mx-2 font-bold text-blue-600">→</span><span>${verbo}</span><span class="mx-2 font-bold text-blue-600">→</span><span>${objeto}</span></li>`
                  ).join('')
                : '';
            
            // 5. Monta o corpo do Modal com a nova estrutura, incluindo as relações
            modalConteudo.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                    <div class="space-y-4">
                        <div><h4 class="font-semibold text-gray-500 text-sm">Autor</h4><p>${trabalho.autorNormalizado || 'Não informado'}</p></div>
                        <div><h4 class="font-semibold text-gray-500 text-sm">Orientador</h4><p>${trabalho.orientadorNormalizado || 'Não informado'}</p></div>
                        <div><h4 class="font-semibold text-gray-500 text-sm">Tipo e Ano</h4><p>${trabalho.tipo} de ${trabalho.ano}</p></div>
                        <div class="mt-4 border-t pt-4"><h4 class="font-semibold text-gray-500 text-sm mb-2">Resumo</h4><div class="max-h-60 overflow-y-auto pr-2 text-sm">${abstractContentHTML}</div></div>
                    </div>
                    <div class="space-y-4 border-t md:border-t-0 md:border-l md:pl-6 pt-4 md:pt-0">
                        ${similarDocsHTML ? `<div><h4 class="font-semibold text-gray-500 text-sm">Trabalhos Semelhantes</h4><ul id="similar-docs-container" class="mt-1 space-y-1 text-sm text-blue-700">${similarDocsHTML}</ul></div>` : ''}
                        ${keywordsHTML ? `<div class="pt-4 ${similarDocsHTML ? 'border-t' : ''}"><h4 class="font-semibold text-gray-500 text-sm">Palavras-chave</h4><div class="flex flex-wrap gap-2 mt-1">${keywordsHTML}</div></div>` : ''}
                        ${relationshipsHTML ? `<div class="pt-4 border-t"><h4 class="font-semibold text-gray-500 text-sm">Relações Conceituais-Chave</h4><ul class="mt-2 space-y-2 text-sm text-gray-700">${relationshipsHTML}</ul></div>` : ''}
                    </div>
                </div>
            `;
            
            // Configura os botões de ação do modal
            document.getElementById('btn-url').onclick = () => window.open(trabalho.url, '_blank');
            document.getElementById('btn-download').onclick = () => window.open(trabalho.document_url, '_blank');
            document.getElementById('btn-copiar').onclick = () => copiarTextoParaClipboard(trabalho.citation || gerarReferencia(trabalho));

            // Exibe o modal
            document.body.classList.add('overflow-hidden');
            modal.classList.remove('hidden');
        }

        /**
         * NOVA FUNÇÃO AUXILIAR: Encontra um trabalho pelo ID e abre o modal.
         */
        function abrirModalPorId(trabalhoId) {
            const trabalho = trabalhosProcessados.find(t => t.id === trabalhoId);
            if (trabalho) {
                abrirModal(trabalho);
            } else {
                console.error('Trabalho não encontrado com o ID:', trabalhoId);
            }
        }

        // Fechar modal
        /**
         * FUNÇÃO ATUALIZADA: Fecha o modal e restaura o estado da página.
         */
         function fecharModal() {
            const modal = document.getElementById('modal-trabalho');
            const btnVoltarTopo = document.getElementById('btn-voltar-topo');

            // Requisito 5: Restaura a visibilidade do botão "Voltar ao Topo"
             if (btnVoltarTopo) {
                // Remove o estilo inline para que o CSS de scroll volte a controlá-lo
                btnVoltarTopo.style.display = ''; 
            }
            
            // Garante que a visualização do resumo seja resetada ao fechar
            modal.classList.remove('modal-abstract-expanded');
            
            document.body.classList.remove('overflow-hidden'); // Libera o scroll da página
            modal.classList.add('hidden');
        }

        /**
         * FUNÇÃO ATUALIZADA: Alterna a visualização focada no resumo dentro do modal.
         */
         function toggleAbstractView(button) {
            const modal = document.getElementById('modal-trabalho');
            const isExpanded = modal.classList.toggle('modal-abstract-expanded');
            
            // Encontra os elementos do resumo dentro do contexto do botão
            const resumoContainer = button.parentElement;
            const resumoTruncado = resumoContainer.querySelector('p:first-of-type');
            const resumoCompleto = resumoContainer.querySelector('p:last-of-type');

            if (isExpanded) {
                button.textContent = 'Voltar';
                resumoTruncado.classList.add('hidden');
                resumoCompleto.classList.remove('hidden');
            } else {
                button.textContent = 'Leia mais...';
                resumoTruncado.classList.remove('hidden');
                resumoCompleto.classList.add('hidden');
            }
        }

        // Gerar referência bibliográfica
        function gerarReferencia(trabalho) {
            const autor = trabalho.autorNormalizado;
            const titulo = trabalho.title;
            const ano = trabalho.ano;
            const tipo = trabalho.tipo;
            
            let referencia = `${autor}. ${titulo}. ${ano}.`;
            
            if (tipo === 'TCC') {
                referencia += ` Trabalho de Conclusão de Curso (Graduação em Biblioteconomia e Documentação)`;
            } else if (tipo === 'Dissertação') {
                referencia += ` Dissertação (Mestrado em Ciência da Informação)`;
            } else if (tipo === 'Tese') {
                referencia += ` Tese (Doutorado em Ciência da Informação)`;
            }
            
            referencia += ` - Universidade Federal Fluminense, Niterói.`;
            
            return referencia;
        }
    
        // Resetar visualizações de grafos
        function resetarVisualizacoesDeGrafos() {
            // --- Reseta a Rede de Colaboração ---
            const redeWrapper = document.getElementById('rede-colaboracao-wrapper');
            const redePlaceholder = document.getElementById('rede-colaboracao-placeholder');

            if (redeNetworkInstance) {
                redeNetworkInstance.destroy();
                redeNetworkInstance = null;
            }
            if (redeWrapper) redeWrapper.classList.add('hidden');
            if (redePlaceholder) redePlaceholder.classList.remove('hidden');

            // --- Reseta o Mapa da Ciência (CORRIGIDO) ---
            const mapaContainer = document.getElementById('mapa-ciencia-container'); // <<-- Alterado de 'mapa-ciencia-wrapper'
            const mapaPlaceholder = document.getElementById('mapa-ciencia-placeholder');

            if (mapaNetworkInstance) {
                mapaNetworkInstance.destroy();
                mapaNetworkInstance = null;
            }
            if (mapaContainer) mapaContainer.classList.add('hidden'); // <<-- Corrigido e com verificação
            if (mapaPlaceholder) mapaPlaceholder.classList.remove('hidden');
        }

        /**
         * Gerencia a exibição de tabelas com a funcionalidade "ver mais".
         * Limita a exibição inicial e adiciona um botão para mostrar todos os itens.
         * @param {HTMLElement} corpoTabelaEl - O elemento tbody da tabela.
         * @param {Array} dadosCompletos - O array completo de dados a ser exibido.
         * @param {HTMLElement} containerBotaoEl - O container onde o botão "ver mais" será inserido.
         * @param {Function} renderizarLinhaFn - A função que sabe como renderizar uma única linha da tabela.
         * @param {string} nomeItem - O nome do item para usar no texto do botão (ex: "orientador").
         */
        function gerenciarPaginacaoTabela(corpoTabelaEl, dadosCompletos, containerBotaoEl, renderizarLinhaFn, nomeItem) {
            const LIMITE_ITENS = 16;
            corpoTabelaEl.innerHTML = '';
            containerBotaoEl.innerHTML = '';

            const itensParaExibir = dadosCompletos.slice(0, LIMITE_ITENS);
            itensParaExibir.forEach(item => corpoTabelaEl.appendChild(renderizarLinhaFn(item)));

            if (dadosCompletos.length > LIMITE_ITENS) {
                const btn = document.createElement('button');
                btn.className = 'bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition-colors';
                btn.textContent = `Ver todos os ${dadosCompletos.length} ${nomeItem}`;
                containerBotaoEl.appendChild(btn);

                btn.addEventListener('click', () => {
                    corpoTabelaEl.innerHTML = ''; // Limpa as linhas iniciais
                    dadosCompletos.forEach(item => corpoTabelaEl.appendChild(renderizarLinhaFn(item)));
                    containerBotaoEl.innerHTML = ''; // Remove o botão
                }, { once: true }); // O evento só dispara uma vez
            }
        }

        // Renderizar índice de orientadores (VERSÃO MELHORADA COM DATA-LABELS)
        function renderizarIndiceOrientadores(orientadoresArray) {
            const corpoTabela = document.getElementById('corpo-tabela-orientadores');
            const containerBotao = document.getElementById('orientadores-ver-mais-container');

            const renderizarLinha = ([nome, dados]) => {
                const row = document.createElement('tr');
                const participacoes = participacoesBancaMap.get(nome) || 0;

                // AQUI ESTÁ A MUDANÇA: Geramos uma estrutura HTML mais rica
                row.innerHTML = `
                    <td class="person-name-cell">
                        <div class="person-name">${nome}</div>
                    </td>
                    <td class="stats-cell">
                        <div class="stats-grid">
                            <div class="stat-item">
                                <span class="stat-label">TCCs</span>
                                <span class="stat-value">${dados.tcc}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Dissertações</span>
                                <span class="stat-value">${dados.dissertacao}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Teses</span>
                                <span class="stat-value">${dados.tese}</span>
                            </div>
                            <div class="stat-item col-span-3">
                                <span class="stat-label">Participação em Bancas</span>
                                <span class="stat-value">${participacoes}</span>
                            </div>
                        </div>
                    </td>
                `;

                row.classList.add('shadow-md', 'sm:shadow-none');

                return row;
            };

            gerenciarPaginacaoTabela(corpoTabela, orientadoresArray, containerBotao, renderizarLinha, "orientadores");
        }

        function aplicarBuscaOrientadores() {
            const termoBusca = normalizarStringParaBusca(document.getElementById('busca-orientadores').value);
            const orientadoresArray = Array.from(orientadoresMap.entries());

            const orientadoresFiltrados = termoBusca
                ? orientadoresArray.filter(([nome, _]) => normalizarStringParaBusca(nome).includes(termoBusca))
                : orientadoresArray;

            renderizarIndiceOrientadores(orientadoresFiltrados.sort((a, b) => a[0].localeCompare(b[0])));
        }

        // Renderizar índice de autores (VERSÃO MELHORADA COM DATA-LABELS)
        function renderizarIndiceAutores(autoresArray) {
            const corpoTabela = document.getElementById('corpo-tabela-autores');
            const containerBotao = document.getElementById('autores-ver-mais-container');

            const renderizarLinha = ([nome, dados]) => {
                const row = document.createElement('tr');
                let evolucao = '';
                if (dados.tcc > 0 && dados.dissertacao > 0 && dados.tese > 0) evolucao = 'TCC → Dissertação → Tese';
                else if (dados.tcc > 0 && dados.dissertacao > 0) evolucao = 'TCC → Dissertação';
                else if (dados.dissertacao > 0 && dados.tese > 0) evolucao = 'Dissertação → Tese';
                else if (dados.tcc > 0) evolucao = 'TCC';
                else if (dados.dissertacao > 0) evolucao = 'Dissertação';
                else if (dados.tese > 0) evolucao = 'Tese';
                
                // AQUI ESTÁ A MUDANÇA: Geramos uma estrutura HTML mais rica
                row.innerHTML = `
                    <td class="person-name-cell">
                        <div class="person-name">${nome}</div>
                    </td>
                    <td class="stats-cell">
                        <div class="stats-grid stats-grid-autores">
                            <div class="stat-item">
                                <span class="stat-label">TCCs</span>
                                <span class="stat-value">${dados.tcc}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Dissertações</span>
                                <span class="stat-value">${dados.dissertacao}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Teses</span>
                                <span class="stat-value">${dados.tese}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Evolução Acadêmica</span>
                                <span class="stat-value-text">${evolucao || 'N/A'}</span>
                            </div>
                        </div>
                    </td>
                `;
                row.classList.add('shadow-md', 'sm:shadow-none');
                return row;
            };
            
            gerenciarPaginacaoTabela(corpoTabela, autoresArray, containerBotao, renderizarLinha, "autores");
        }

        function aplicarBuscaAutores() {
            const termoBusca = normalizarStringParaBusca(document.getElementById('busca-autores').value);
            const autoresArray = Array.from(autoresMap.entries());
            
            const autoresFiltrados = termoBusca
                ? autoresArray.filter(([nome, _]) => normalizarStringParaBusca(nome).includes(termoBusca))
                : autoresArray;

            renderizarIndiceAutores(autoresFiltrados.sort((a, b) => a[0].localeCompare(b[0])));
        }

        // Renderizar evolução acadêmica
        /**
         * FUNÇÃO ATUALIZADA: Ordena a evolução acadêmica pelo nível do trabalho,
         * garantindo a ordem correta da progressão (TCC -> Dissertação -> Tese).
         */
         function renderizarEvolucaoAcademica() {
            const listaEvolucao = document.getElementById('lista-evolucao');
            listaEvolucao.innerHTML = '';
            
            const autoresComEvolucao = Array.from(autoresMap.entries())
                .filter(([nome, dados]) => 
                    (dados.tcc > 0 && dados.dissertacao > 0) || 
                    (dados.dissertacao > 0 && dados.tese > 0) || 
                    (dados.tcc > 0 && dados.tese > 0)
                )
                .sort((a, b) => a[0].localeCompare(b[0]));
            
            if (autoresComEvolucao.length === 0) {
                listaEvolucao.innerHTML = '<p class="text-gray-500 col-span-full">Nenhum autor com evolução acadêmica foi encontrado para os filtros selecionados.</p>';
                return;
            }
            
            // Define o peso de cada tipo de trabalho para a ordenação
            const tipoPeso = { 'TCC': 1, 'Dissertação': 2, 'Tese': 3, 'Outro': 4 };

            autoresComEvolucao.forEach(([nome, dados]) => {
                const autorEl = document.createElement('div');
                autorEl.className = 'bg-gray-50 p-4 rounded-lg border';
                
                // AQUI ESTÁ A CORREÇÃO: Ordena primeiro pelo peso do tipo, depois pelo ano
                const trabalhosAutor = trabalhosProcessados
                    .filter(t => t.autorNormalizado === nome)
                    .sort((a, b) => {
                        const pesoA = tipoPeso[a.tipo] || 99;
                        const pesoB = tipoPeso[b.tipo] || 99;
                        
                        // Se os níveis forem diferentes, ordena pelo nível
                        if (pesoA !== pesoB) {
                            return pesoA - pesoB;
                        }
                        
                        // Se os níveis forem iguais, ordena pelo ano
                        return (a.ano || 0) - (b.ano || 0); 
                    });
                
                const trabalhosHTML = trabalhosAutor.map(trabalho => {
                    return `
                        <div class="mt-2 pl-4 border-l-2 border-gray-300">
                            <span class="text-xs font-bold text-gray-600">${trabalho.tipo} (${trabalho.ano})</span>
                            <button onclick="abrirModalPorId('${trabalho.id}')" class="block w-full text-left text-blue-700 hover:underline text-sm font-medium leading-tight">
                                ${trabalho.title}
                            </button>
                        </div>
                    `;
                }).join('');
                
                autorEl.innerHTML = `
                    <h3 class="font-semibold text-blue-800 text-lg">${nome}</h3>
                    <div class="mt-2">${trabalhosHTML}</div>
                `;
                
                listaEvolucao.appendChild(autorEl);
            });
        }

        /**
         * Calcula os scores de relevância para todas as palavras-chave no corpus.
         * O score é uma multiplicação da Frequência Total pelo IDF (Inverse Document Frequency).
         * Retorna um Map com a palavra como chave e seu score como valor.
         * @param {Array} trabalhos - O array de trabalhos (filtrado ou completo).
         * @param {Map} frequenciaTotalMap - O mapa com a contagem de frequência total de cada palavra (palavrasChaveMap).
         * @returns {Map<string, number>} - Um mapa de palavras e seus scores de relevância.
         */
        function calcularScoresNuvem(trabalhos, frequenciaTotalMap) {
            const scoresFinais = new Map();
            const totalDocumentos = trabalhos.length;

            if (totalDocumentos === 0) return scoresFinais;

            // Passo 1: Calcular a Frequência nos Documentos (DF) para cada palavra
            // Ou seja, em quantos trabalhos cada palavra aparece pelo menos uma vez.
            const dfMap = new Map();
            trabalhos.forEach(trabalho => {
                const palavrasUnicasNoDoc = new Set(trabalho.todasPalavrasChave);
                palavrasUnicasNoDoc.forEach(palavra => {
                    dfMap.set(palavra, (dfMap.get(palavra) || 0) + 1);
                });
            });

            // Passo 2: Calcular o score final (Frequência Total * IDF) para cada palavra
            frequenciaTotalMap.forEach((frequencia, palavra) => {
                const df = dfMap.get(palavra) || 1; // Document Frequency da palavra
                // A fórmula do IDF penaliza palavras que aparecem em muitos documentos.
                const idf = Math.log(totalDocumentos / df); 
                const score = frequencia * idf;
                scoresFinais.set(palavra, score);
            });

            return scoresFinais;
        }

        // Gerar nuvem de palavras
        function gerarNuvemPalavras() {
            const canvas = document.getElementById('nuvem-palavras-canvas');
            const legenda = document.getElementById('legenda-nuvem');
            
            canvas.innerHTML = ''; // Limpa o canvas
            
            // Usa o mapa de frequência já calculado pela função atualizarDashboard
            if (palavrasChaveMap.size === 0) {
                canvas.innerHTML = '<p class="text-gray-500 text-center py-8">Não há palavras-chave para os filtros selecionados.</p>';
                legenda.innerHTML = '';
                return;
            }

            // >>> NOVA LÓGICA: CALCULAR SCORES DE RELEVÂNCIA <<<
            const scoresNuvem = calcularScoresNuvem(filteredTrabalhos, palavrasChaveMap);

            // Converte os scores em uma lista no formato [palavra, peso]
            const scoresArray = Array.from(scoresNuvem.entries());
            const maxScore = scoresArray.length > 0 ? Math.max(...scoresArray.map(item => item[1])) : 0;
            
            const listaNuvem = scoresArray
                .map(([palavra, score]) => [palavra, (score / maxScore) * 50 + 10]) // Normaliza e ajusta a escala
                .sort((a, b) => b[1] - a[1]) // Ordena pelo peso
                .slice(0, 60); // Limita às 60 palavras mais relevantes

            if (listaNuvem.length === 0 || maxScore === 0) {
                canvas.innerHTML = '<p class="text-gray-500 text-center py-8">Não há palavras-chave relevantes para gerar a nuvem.</p>';
                legenda.innerHTML = '';
                return;
            }

            try {
                WordCloud(canvas, {
                    list: listaNuvem,
                    gridSize: Math.round(16 * 1024 / canvas.offsetWidth),
                    weightFactor: 8,
                    fontFamily: 'Arial, sans-serif',
                    color: function () {
                        const colors = ['#1e3a8a', '#3b82f6', '#10b981', '#8b5cf6', '#4b5563'];
                        return colors[Math.floor(Math.random() * colors.length)];
                    },
                    rotateRatio: 0.3,
                    rotationSteps: 2,
                    backgroundColor: '#ffffff',
                    shrinkToFit: true,
                    minSize: 8,
                    drawOutOfBound: false
                });

                // Gerar legenda com base nos scores
                const palavrasDestacadas = scoresArray
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 8);
                    
                legenda.innerHTML = '<p class="font-medium mb-2">Termos mais relevantes (Score de Relevância):</p>' +
                    palavrasDestacadas.map(([palavra, score]) => 
                        `<span class="inline-block bg-gray-100 px-3 py-1 rounded text-sm mr-2 mb-2">
                            <span class="font-semibold">${palavra}:</span> ${score.toFixed(2)}
                        </span>`
                    ).join('');

            } catch (error) {
                console.error('Erro ao gerar nuvem de palavras:', error);
                canvas.innerHTML = '<p class="text-red-500 text-center py-8">Erro ao gerar nuvem de palavras.</p>';
                legenda.innerHTML = '';
            }
        }

        /**
         * Processa os dados de trabalhos e renderiza um grafo de colaboração.
         */
        function renderizarRedeColaboracao(trabalhos) {
            
            const container = document.getElementById('rede-colaboracao-container');
            const containerMetricas = document.getElementById('metricas-rede');
            container.innerHTML = '';
            containerMetricas.innerHTML = '';

            // Lê os valores dos controles
            const numPesquisadores = parseInt(document.getElementById('slider-pesquisadores').value, 10);
            const mostrarOrientadores = document.getElementById('check-orientadores').checked;
            const mostrarAutores = document.getElementById('check-autores').checked;
            const mostrarBancas = document.getElementById('check-bancas').checked;

            // Passo 1: Calcular a centralidade (nº de conexões) de TODOS os pesquisadores
            const centralidadeMap = new Map();
            const todasArestas = [];
            trabalhos.forEach(trabalho => {
                const autor = trabalho.autorNormalizado;
                const orientador = trabalho.orientadorNormalizado;
                const banca = trabalho.bancaNormalizada || [];
                const participantes = new Set([autor, orientador, ...banca].filter(p => p));
                
                participantes.forEach(p1 => {
                    participantes.forEach(p2 => {
                        if (p1 < p2) { // Evita duplicatas e auto-loops
                            centralidadeMap.set(p1, (centralidadeMap.get(p1) || 0) + 1);
                            centralidadeMap.set(p2, (centralidadeMap.get(p2) || 0) + 1);
                            todasArestas.push({ from: p1, to: p2 });
                        }
                    });
                });
            });

            // Passo 2: Filtrar os pesquisadores mais centrais
            const topPesquisadores = new Set(
                Array.from(centralidadeMap.entries())
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, numPesquisadores)
                    .map(item => item[0])
            );

            // Passo 3: Construir os nós e arestas finais para a visualização
            const nodesMap = new Map();
            const edges = [];

            trabalhos.forEach(trabalho => {
                const autor = trabalho.autorNormalizado;
                const orientador = trabalho.orientadorNormalizado;
                const banca = trabalho.bancaNormalizada || [];

                // Adiciona Nós (se estiverem no top e seu tipo estiver checado)
                const addNode = (nome, tipo) => {
                    if (nome && topPesquisadores.has(nome) && !nodesMap.has(nome)) {
                        nodesMap.set(nome, { id: nome, label: nome, group: tipo, value: centralidadeMap.get(nome) });
                    }
                };

                if (mostrarOrientadores) addNode(orientador, 'Orientador');
                if (mostrarAutores) addNode(autor, 'Autor');
                if (mostrarBancas) banca.forEach(membro => addNode(membro, 'Banca'));
            });

            // Adiciona Arestas (apenas se ambos os nós da aresta estiverem visíveis)
            todasArestas.forEach(aresta => {
                if (nodesMap.has(aresta.from) && nodesMap.has(aresta.to)) {
                    edges.push(aresta);
                }
            });
            
            const nodes = Array.from(nodesMap.values());
            if (nodes.length === 0) {
                container.innerHTML = `<div class="flex items-center justify-center h-full"><p class="text-center text-gray-600 p-8">Nenhuma rede encontrada para os filtros selecionados. Tente aumentar o número de pesquisadores.</p></div>`;
                return;
            }

            // Renderiza as métricas dos mais centrais (que estão visíveis)
            containerMetricas.innerHTML = `
                <ul class="list-decimal list-inside">
                    ${nodes.sort((a, b) => b.value - a.value).slice(0, 10).map(n => `<li>${n.label} (${n.value} conexões)</li>`).join('')}
                </ul>`;

            // Passo 4: Configurar e renderizar o grafo
            const data = { nodes, edges };
            const options = {
                nodes: {
                    shape: 'dot',
                    font: { size: 12, face: 'Arial' }
                },
                edges: {
                    width: 0.5,
                    color: { inherit: 'from' },
                    smooth: { type: 'continuous' }
                },
                physics: {
                    forceAtlas2Based: {
                        gravitationalConstant: -26,
                        centralGravity: 0.005,
                        springLength: 230,
                        springConstant: 0.18
                    },
                    maxVelocity: 146,
                    solver: 'forceAtlas2Based',
                    timestep: 0.35,
                    stabilization: { iterations: 150 }
                },
                interaction: {
                    hover: true,
                    tooltipDelay: 200,
                    hideEdgesOnDrag: true
                },
                groups: {
                    Orientador: { color: { background: '#3b82f6', border: '#1e40af' }, size: 25 },
                    Banca: { color: { background: '#8b5cf6', border: '#5b21b6' }, size: 15 },
                    Autor: { color: { background: '#10b981', border: '#047857' }, size: 10 }
                }
            };
            
            if (redeNetworkInstance) redeNetworkInstance.destroy();
            redeNetworkInstance = new vis.Network(container, data, options);
        }

        function configurarControlesRedeColaboracao() {
            const sliderPesquisadores = document.getElementById('slider-pesquisadores');
            const valorSliderPesquisadores = document.getElementById('valor-slider-pesquisadores');
            const btnRenderRede = document.getElementById('btn-render-rede');
            const placeholder = document.getElementById('rede-colaboracao-placeholder');
            const wrapper = document.getElementById('rede-colaboracao-wrapper');

            // Listener para o slider
            sliderPesquisadores.addEventListener('input', () => {
                valorSliderPesquisadores.textContent = `${sliderPesquisadores.value} pesquisadores`;
            });

            // Listener para o botão de GERAR
            btnRenderRede.addEventListener('click', () => {
                placeholder.classList.add('hidden');
                wrapper.classList.remove('hidden');
                const container = document.getElementById('rede-colaboracao-container');
                container.innerHTML = `<div class="flex items-center justify-center h-full"><p class="text-gray-600">Renderizando... por favor, aguarde.</p></div>`;
                
                setTimeout(() => {
                    renderizarRedeColaboracao(filteredTrabalhos);
                    
                    document.getElementById('btn-fechar-rede').addEventListener('click', () => {
                        if (redeNetworkInstance) {
                            redeNetworkInstance.destroy();
                            redeNetworkInstance = null;
                        }
                        wrapper.classList.add('hidden');
                        placeholder.classList.remove('hidden');
                    }, { once: true });
                }, 50);
            });
        }

        /**
         * Renderiza um grafo de coocorrência de temas (descritores).
         */
        function renderizarMapaDaCiencia(trabalhos) {
            const container = document.getElementById('mapa-ciencia-container');
            const placeholder = document.getElementById('mapa-ciencia-placeholder');
            const containerMetricas = document.getElementById('metricas-mapa-ciencia');

            // Mostra o placeholder e esconde o container do gráfico
            container.innerHTML = '';
            container.classList.add('hidden');
            placeholder.classList.remove('hidden');
            placeholder.innerHTML = `<p class="text-center text-gray-600">Renderizando... por favor, aguarde.</p>`;
            
            // Lê os valores dos sliders
            const numTemas = parseInt(document.getElementById('slider-temas').value, 10);
            const minConexoes = parseInt(document.getElementById('slider-conexoes').value, 10);

            const nodesMap = new Map();
            const edgesMap = new Map();

            // Processa os trabalhos para obter todas as frequências e coocorrências
            trabalhos.forEach(trabalho => {
                const temas = trabalho.descriptors;
                if (!temas || temas.length < 2) return;
                temas.forEach(tema => {
                    nodesMap.set(tema, (nodesMap.get(tema) || 0) + 1);
                });
                for (let i = 0; i < temas.length; i++) {
                    for (let j = i + 1; j < temas.length; j++) {
                        const par = [temas[i], temas[j]].sort();
                        const chave = par.join('|');
                        edgesMap.set(chave, (edgesMap.get(chave) || 0) + 1);
                    }
                }
            });

            // >>> AQUI ESTÁ A LÓGICA DE FILTRAGEM <<<
            // 1. Filtra os temas mais frequentes (Nós)
            const topTemas = Array.from(nodesMap.entries())
                .sort((a, b) => b[1] - a[1])
                .slice(0, numTemas)
                .map(item => item[0]);
            const topTemasSet = new Set(topTemas);

            // 2. Filtra as conexões mais fortes (Arestas) que conectam os temas filtrados
            const arestasFiltradas = Array.from(edgesMap.entries())
                .filter(([chave, peso]) => {
                    const [tema1, tema2] = chave.split('|');
                    return peso >= minConexoes && topTemasSet.has(tema1) && topTemasSet.has(tema2);
                });

            if (topTemas.length === 0 || arestasFiltradas.length === 0) {
                placeholder.innerHTML = `<p class="text-center text-gray-600">Nenhum resultado encontrado para os filtros selecionados. Tente diminuir a força da conexão ou aumentar o número de temas.</p>`;
                containerMetricas.innerHTML = '';
                return;
            }

            // Converte os dados filtrados para o formato do Vis.js
            const nodes = topTemas.map(tema => ({
                id: tema,
                label: tema,
                value: nodesMap.get(tema),
                title: `${tema} (${nodesMap.get(tema)} trabalhos)`
            }));

            const edges = arestasFiltradas.map(([chave, peso]) => ({
                from: chave.split('|')[0],
                to: chave.split('|')[1],
                value: peso,
                title: `Coocorrências: ${peso}`
            }));

            // Renderiza as métricas
            containerMetricas.innerHTML = `
                <ul class="list-decimal list-inside">
                    ${arestasFiltradas.sort((a, b) => b[1] - a[1]).slice(0, 10).map(([chave, peso]) => `<li>${chave.replace(/\|/g, ' & ')} (${peso} vezes)</li>`).join('')}
                </ul>`;

            // Configura e renderiza o grafo
            placeholder.classList.add('hidden');
            container.classList.remove('hidden');
            const data = { nodes, edges };
            const options = {
                nodes: {
                    shape: 'box',
                    font: { size: 14, color: '#ffffff' },
                    color: {
                        background: '#1e3a8a',
                        border: '#1d4ed8',
                        highlight: { background: '#ef4444', border: '#b91c1c' },
                        hover: { background: '#3b82f6', border: '#2563eb' }
                    },
                    margin: 10
                },
                edges: {
                    width: 0.5,
                    color: { color: '#cbd5e1', highlight: '#ef4444', hover: '#94a3b8' },
                    smooth: { type: 'continuous' }
                },
                physics: {
                    barnesHut: {
                        gravitationalConstant: -10000,
                        springConstant: 0.01,
                        centralGravity: 0.1
                    },
                    minVelocity: 0.75
                },
                interaction: {
                    hover: true,
                    tooltipDelay: 200
                }
            };
            
            if (mapaNetworkInstance) mapaNetworkInstance.destroy();
            mapaNetworkInstance = new vis.Network(container, data, options);
        }

        // Handler para o botão de renderização do mapa
        function configurarControlesMapaCiencia() {
            const sliderTemas = document.getElementById('slider-temas');
            const valorSliderTemas = document.getElementById('valor-slider-temas');
            const sliderConexoes = document.getElementById('slider-conexoes');
            const valorSliderConexoes = document.getElementById('valor-slider-conexoes');
            const btnRenderMapa = document.getElementById('btn-render-mapa');

            // Atualiza o texto ao mover o slider de temas
            sliderTemas.addEventListener('input', () => {
                valorSliderTemas.textContent = `${sliderTemas.value} temas`;
            });

            // Atualiza o texto ao mover o slider de conexões
            sliderConexoes.addEventListener('input', () => {
                const valor = sliderConexoes.value;
                valorSliderConexoes.textContent = `${valor} coocorrências`;
            });

            // O botão agora chama a função de renderização
            btnRenderMapa.addEventListener('click', () => {
                renderizarMapaDaCiencia(filteredTrabalhos);
            });
        }

        /**
         * Processa os dados para agrupar a contagem de palavras-chave por ano.
         */
         function processarDadosTemas() {
            trabalhosProcessados.forEach(trabalho => {
                const ano = trabalho.ano;
                if (ano === 'Não informado') return; // Ignora trabalhos sem ano

                trabalho.todasPalavrasChave.forEach(palavra => {
                    // Inicializa o mapa para a palavra-chave se não existir
                    if (!temasPorAno.has(palavra)) {
                        temasPorAno.set(palavra, new Map());
                    }
                    const mapaAnos = temasPorAno.get(palavra);

                    // Incrementa a contagem para o ano específico
                    const contagemAtual = mapaAnos.get(ano) || 0;
                    mapaAnos.set(ano, contagemAtual + 1);
                });
            });
        }

        /**
         * Renderiza os controles e o gráfico para a análise de evolução temática.
         */
        function renderizarEvolucaoTemas() {
            const selectTema = document.getElementById('filtro-tema');
            const containerGrafico = document.getElementById('grafico-evolucao-container');
            const promptGrafico = document.getElementById('grafico-prompt');
            const canvas = document.getElementById('grafico-evolucao-tema');
            
            // Popula o dropdown com os temas, ordenados alfabeticamente
            const temasOrdenados = Array.from(temasPorAno.keys()).sort((a, b) => a.localeCompare(b));
            temasOrdenados.forEach(tema => {
                const option = document.createElement('option');
                option.value = tema;
                option.textContent = tema;
                selectTema.appendChild(option);
            });

            // Função para atualizar o gráfico
            function atualizarGrafico(tema) {
                // Se um gráfico anterior existe, destrua-o para criar um novo
                if (graficoEvolucaoTema) {
                    graficoEvolucaoTema.destroy();
                }

                if (!tema) {
                    containerGrafico.style.display = 'none';
                    promptGrafico.style.display = 'block';
                    return;
                }
                
                containerGrafico.style.display = 'block';
                promptGrafico.style.display = 'none';

                const dadosTema = temasPorAno.get(tema);
                const anosLabels = Array.from(anos).filter(ano => ano !== 'Não informado').sort();
                
                const dadosContagem = anosLabels.map(ano => dadosTema.get(ano) || 0);

                const ctx = canvas.getContext('2d');
                graficoEvolucaoTema = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: anosLabels,
                        datasets: [{
                            label: `Ocorrências de "${tema}"`,
                            data: dadosContagem,
                            borderColor: '#0d9488', // Cor Teal
                            backgroundColor: 'rgba(13, 148, 136, 0.1)',
                            fill: true,
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1 // Garante que o eixo Y seja de números inteiros
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: `Evolução Anual do Tema: ${tema}`
                            }
                        }
                    }
                });
            }

            // Adiciona o event listener para o dropdown
            selectTema.addEventListener('change', (e) => {
                atualizarGrafico(e.target.value);
            });
            
            // Estado inicial
            atualizarGrafico('');
        }

        /**
         * Processa os dados brutos para criar um mapa de temas com todas as informações necessárias.
         * Deve ser chamada após processarDados().
         */
         function processarDadosMapaTematico() {
            temasMap.clear(); // Limpa o mapa para garantir que não haja dados antigos

            trabalhosProcessados.forEach(trabalho => {
                if (!trabalho.descriptors || trabalho.descriptors.length === 0) {
                    return; // Pula trabalhos sem descritores (temas principais)
                }

                trabalho.descriptors.forEach(tema => {
                    // Se o tema ainda não está no mapa, inicializa sua estrutura
                    if (!temasMap.has(tema)) {
                        temasMap.set(tema, {
                            tcc: 0,
                            dissertacao: 0,
                            tese: 0,
                            autores: new Set(),
                            orientadores: new Set(),
                            assuntosRelacionados: new Map()
                        });
                    }

                    const temaData = temasMap.get(tema);

                    // 1. Incrementa o contador do tipo de trabalho
                    if (trabalho.tipo === 'TCC') temaData.tcc++;
                    else if (trabalho.tipo === 'Dissertação') temaData.dissertacao++;
                    else if (trabalho.tipo === 'Tese') temaData.tese++;

                    // 2. Adiciona autor e orientador (Sets evitam duplicatas)
                    if (trabalho.autorNormalizado) temaData.autores.add(trabalho.autorNormalizado);
                    if (trabalho.orientadorNormalizado) temaData.orientadores.add(trabalho.orientadorNormalizado);
                    
                    // 3. Adiciona todas as palavras-chave como assuntos relacionados
                    trabalho.todasPalavrasChave.forEach(palavra => {
                        if (palavra.toLowerCase() !== tema.toLowerCase()) {
                            const currentCount = temaData.assuntosRelacionados.get(palavra) || 0;
                            temaData.assuntosRelacionados.set(palavra, currentCount + 1);
                        }
                    });
                });
            });
        }

        /**
         * Renderiza a tabela principal do Mapa Temático com a contagem de trabalhos por tema.
         */
         function renderizarMapaTematicoTabela(temasParaRenderizar) { // Agora aceita um array
            const corpoTabela = document.getElementById('corpo-tabela-temas');
            const containerBotao = document.getElementById('temas-ver-mais-container');

            // Calcula o total de trabalhos por tema para o ranking
            const temasComTotal = Array.from(temasMap.entries()).map(([tema, dados]) => ({
                tema,
                total: dados.tcc + dados.dissertacao + dados.tese
            }));
            temasComTotal.sort((a, b) => b.total - a.total);
            const top10Temas = new Set(temasComTotal.slice(0, 10).map(item => item.tema));

            // A função de renderizar a linha permanece a mesma, mas agora usa o array filtrado
            const renderizarLinha = ([tema, dados]) => {
                const row = document.createElement('tr');
                const isTop10 = top10Temas.has(tema);
                row.innerHTML = `
                    <td class="px-6 py-4 font-medium text-gray-800" data-label="Tema Principal">
                        ${tema} ${isTop10 ? '<span title="Top 10 temas mais frequentes">🚩</span>' : ''}
                    </td>
                    <td class="px-6 py-4 text-center" data-label="TCCs">${dados.tcc}</td>
                    <td class="px-6 py-4 text-center" data-label="Dissertações">${dados.dissertacao}</td>
                    <td class="px-6 py-4 text-center" data-label="Teses">${dados.tese}</td>
                `;
                return row;
            };

            gerenciarPaginacaoTabela(corpoTabela, temasParaRenderizar, containerBotao, renderizarLinha, "temas");
        }
        
        /**
         * Popula o <select> com os temas disponíveis.
         */
        function popularFiltroMapaTematico() {
            const selectTema = document.getElementById('filtro-mapa-tema');
            const temasOrdenados = Array.from(temasMap.keys()).sort();

            temasOrdenados.forEach(tema => {
                const option = document.createElement('option');
                option.value = tema;
                option.textContent = tema;
                selectTema.appendChild(option);
            });
        }

        /**
         * Exibe os detalhes (autores, orientadores, assuntos) de um tema selecionado.
         * @param {string} temaSelecionado - O tema escolhido no <select>.
         */
         function exibirDetalhesTema(temaSelecionado) {
            const containerDetalhes = document.getElementById('detalhes-tema-container');
            const prompt = document.getElementById('prompt-tema');

            if (!temaSelecionado) {
                containerDetalhes.classList.add('hidden');
                prompt.classList.remove('hidden');
                return;
            }

            const dadosTema = temasMap.get(temaSelecionado);
            if (!dadosTema) return;

            const listaAssuntos = document.getElementById('lista-assuntos-tema');
            const listaAutores = document.getElementById('lista-autores-tema');
            const listaOrientadores = document.getElementById('lista-orientadores-tema');

            listaAssuntos.innerHTML = '';
            listaAutores.innerHTML = '';
            listaOrientadores.innerHTML = '';

            // Lógica para o ranking de Assuntos Relacionados
            const assuntosArray = Array.from(dadosTema.assuntosRelacionados.entries());
            assuntosArray.sort((a, b) => b[1] - a[1]); // Ordena por frequência (desc)
            const top10Assuntos = new Set(assuntosArray.slice(0, 10).map(item => item[0]));

            // Popula a lista de assuntos, agora com a flag
            const assuntosHtml = assuntosArray
                .sort((a, b) => a[0].localeCompare(b[0])) // Reordena alfabeticamente para exibição
                .map(([assunto, _]) => {
                    const isTop10 = top10Assuntos.has(assunto);
                    return `<li>${assunto} ${isTop10 ? '<span title="Top 10 assuntos mais relacionados">🚩</span>' : ''}</li>`;
                }).join('');
            listaAssuntos.innerHTML = assuntosHtml || '<li>Nenhum assunto relacionado encontrado.</li>';

            const autoresHtml = Array.from(dadosTema.autores).sort().map(autor => `<li>${autor}</li>`).join('');
            listaAutores.innerHTML = autoresHtml || '<li>Nenhum autor encontrado para este tema.</li>';

            const orientadoresHtml = Array.from(dadosTema.orientadores).sort().map(orientador => `<li>${orientador}</li>`).join('');
            listaOrientadores.innerHTML = orientadoresHtml || '<li>Nenhum orientador encontrado para este tema.</li>';

            containerDetalhes.classList.remove('hidden');
            prompt.classList.add('hidden');
        }

        /**
         * Aplica a busca na tabela do Mapa Temático.
         */
        function aplicarBuscaMapaTematico() {
            const termoBusca = normalizarStringParaBusca(document.getElementById('busca-mapa-tematico').value);
            const temasArray = Array.from(temasMap.entries());

            const temasFiltrados = termoBusca
                ? temasArray.filter(([tema, _]) => normalizarStringParaBusca(tema).includes(termoBusca))
                : temasArray;

            renderizarMapaTematicoTabela(temasFiltrados.sort((a, b) => a[0].localeCompare(b[0])));
        }

        /**
         * FUNÇÃO ATUALIZADA: Análise da Jornada do Autor
         * Os cards de trabalho agora são clicáveis e abrem o modal de detalhes.
         */
         function renderizarJornadaAutor() {
            const selectAutor = document.getElementById('filtro-autor-jornada');
            const containerResultado = document.getElementById('jornada-autor-resultado');

            // Popula o <select> com os nomes dos autores, ordenados alfabeticamente
            // (Esta parte da lógica é otimizada para não repopular a cada chamada)
            if (selectAutor.options.length <= 1) {
                const nomesAutores = Array.from(autoresMap.keys()).sort();
                nomesAutores.forEach(nome => {
                    const option = document.createElement('option');
                    option.value = nome;
                    option.textContent = nome;
                    selectAutor.appendChild(option);
                });
            }

            // Função para exibir os detalhes de um autor selecionado
            function exibirDetalhesAutor(nomeAutor) {
                if (!nomeAutor) {
                    containerResultado.innerHTML = `<p class="text-center text-gray-500">Selecione um autor na lista acima para visualizar os detalhes.</p>`;
                    return;
                }

                const trabalhosDoAutor = trabalhosProcessados
                    .filter(t => t.autorNormalizado === nomeAutor)
                    .sort((a, b) => (a.ano || 0) - (b.ano || 0)); // Ordena do mais antigo para o mais novo

                let htmlResultado = `
                    <h3 class="text-xl font-bold text-blue-800 mb-4">${nomeAutor}</h3>
                    <div class="space-y-6">
                `;

                trabalhosDoAutor.forEach(trabalho => {
                    let tipoBgColor = 'bg-gray-100';
                    if (trabalho.tipo === 'TCC') tipoBgColor = 'bg-blue-50';
                    if (trabalho.tipo === 'Dissertação') tipoBgColor = 'bg-green-50';
                    if (trabalho.tipo === 'Tese') tipoBgColor = 'bg-purple-50';
                    
                    // AQUI ESTÁ A MUDANÇA: Adicionado o onclick e classes de interação
                    htmlResultado += `
                        <div class="p-4 rounded-lg border ${tipoBgColor} cursor-pointer hover:shadow-md hover:border-gray-400 transition-all duration-200"
                             onclick="abrirModalPorId('${trabalho.id}')">
                            <div class="flex justify-between items-start">
                                <h4 class="text-lg font-semibold text-gray-900">${trabalho.title}</h4>
                                <span class="text-sm font-bold text-gray-700 whitespace-nowrap ml-4">${trabalho.ano} - ${trabalho.tipo}</span>
                            </div>
                            <div class="mt-2 text-sm text-gray-600">
                                <p><span class="font-medium">Orientador:</span> ${trabalho.orientadorNormalizado || 'Não informado'}</p>
                                <p><span class="font-medium">Banca:</span> ${trabalho.bancaNormalizada && trabalho.bancaNormalizada.length > 0 ? trabalho.bancaNormalizada.join(', ') : 'Não informado'}</p>
                            </div>
                            <div class="mt-3">
                                <p class="text-xs font-semibold text-gray-700 mb-1">Palavras-chave:</p>
                                <div class="flex flex-wrap gap-1">
                                    ${trabalho.todasPalavrasChave.slice(0, 5).map(kw => `<span class="bg-white rounded-full px-2 py-0.5 text-xs font-medium text-gray-600 border">${kw}</span>`).join('')}
                                    ${trabalho.todasPalavrasChave.length > 5 ? `<span class="bg-white rounded-full px-2 py-0.5 text-xs font-medium text-gray-600 border">+${trabalho.todasPalavrasChave.length - 5}</span>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });

                htmlResultado += `</div>`;
                containerResultado.innerHTML = htmlResultado;
            }

            // Adiciona o event listener para o <select>
            selectAutor.addEventListener('change', (e) => {
                exibirDetalhesAutor(e.target.value);
            });
            
            // Exibe o estado inicial (prompt para selecionar) se nenhum autor estiver selecionado
            if (!selectAutor.value) {
                 exibirDetalhesAutor('');
            }
        }

        /**
         * FUNÇÃO ATUALIZADA: Renderiza os gráficos de indicadores infométricos
         * com a contagem de licenças corrigida.
         */
         function renderizarIndicadoresInfometricos(trabalhos) {
            // Destrói instâncias anteriores dos gráficos para evitar sobreposição
            if (graficoTimeToOnline) graficoTimeToOnline.destroy();
            if (graficoLicencas) graficoLicencas.destroy();

            // --- Lógica para o Gráfico Time-to-Online ---
            const timeDiffs = {
                'Mesmo ano': 0, '1 ano depois': 0, '2 anos depois': 0, '3+ anos depois': 0
            };
            trabalhos.forEach(trabalho => {
                const anoPublicacao = parseInt(trabalho.date_issued, 10);
                if (trabalho.date_available && !isNaN(anoPublicacao)) {
                    const anoDisponivel = new Date(trabalho.date_available).getFullYear();
                    if (!isNaN(anoDisponivel)) {
                        const diff = anoDisponivel - anoPublicacao;
                        if (diff <= 0) timeDiffs['Mesmo ano']++;
                        else if (diff === 1) timeDiffs['1 ano depois']++;
                        else if (diff === 2) timeDiffs['2 anos depois']++;
                        else if (diff >= 3) timeDiffs['3+ anos depois']++;
                    }
                }
            });

            const ctxTimeToOnline = document.getElementById('grafico-time-to-online').getContext('2d');
            graficoTimeToOnline = new Chart(ctxTimeToOnline, {
                type: 'bar',
                data: {
                    labels: Object.keys(timeDiffs),
                    datasets: [{
                        label: 'Nº de Trabalhos',
                        data: Object.values(timeDiffs),
                        backgroundColor: ['rgba(54, 162, 235, 0.6)', 'rgba(255, 206, 86, 0.6)', 'rgba(255, 159, 64, 0.6)', 'rgba(255, 99, 132, 0.6)'],
                        borderColor: ['rgba(54, 162, 235, 1)', 'rgba(255, 206, 86, 1)', 'rgba(255, 159, 64, 1)', 'rgba(255, 99, 132, 1)'],
                        borderWidth: 1
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });

            // --- Lógica para o Gráfico de Licenças (CORRIGIDA) ---
            const licenseCounts = new Map();
            trabalhos.forEach(trabalho => {
                // AQUI ESTÁ A MUDANÇA: Usa a nova função de normalização
                const license = normalizarLicenca(trabalho.rights_license);
                licenseCounts.set(license, (licenseCounts.get(license) || 0) + 1);
            });

            const ctxLicencas = document.getElementById('grafico-licencas').getContext('2d');
            graficoLicencas = new Chart(ctxLicencas, {
                type: 'pie',
                data: {
                    labels: Array.from(licenseCounts.keys()),
                    datasets: [{
                        data: Array.from(licenseCounts.values()),
                        // Adicionamos mais cores para o caso de haver mais licenças
                        backgroundColor: ['#3b82f6', '#10b981', '#8b5cf6', '#f59e0b', '#ef4444', '#6b7280', '#ec4899'],
                        hoverOffset: 4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } } }
            });
        }


        /**
         * Renderiza os gráficos de barras para as entidades mais citadas (ORG e LOC).
         */
         function renderizarGraficosEntidades(trabalhos) {
            // Garante que instâncias anteriores dos gráficos sejam destruídas
            if (graficoEntidadesOrg) graficoEntidadesOrg.destroy();
            if (graficoEntidadesLoc) graficoEntidadesLoc.destroy();

            const orgCounts = new Map();
            const locCounts = new Map();

            // 1. Processa e conta todas as entidades do tipo ORG e LOC
            trabalhos.forEach(trabalho => {
                if (trabalho.entities) {
                    trabalho.entities.forEach(entity => {
                        if (entity.type === 'ORG') {
                            orgCounts.set(entity.text, (orgCounts.get(entity.text) || 0) + 1);
                        } else if (entity.type === 'LOC') {
                            locCounts.set(entity.text, (locCounts.get(entity.text) || 0) + 1);
                        }
                    });
                }
            });

            // Função auxiliar para criar um gráfico
            const criarGrafico = (canvasId, dataMap, label) => {
                const top10 = Array.from(dataMap.entries())
                    .sort((a, b) => b[1] - a[1]) // Ordena por contagem
                    .slice(0, 10) // Pega os 10 primeiros
                    .reverse(); // Inverte para o maior ficar no topo no gráfico de barras horizontal

                const ctx = document.getElementById(canvasId).getContext('2d');
                return new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: top10.map(item => item[0]),
                        datasets: [{
                            label: label,
                            data: top10.map(item => item[1]),
                            backgroundColor: 'rgba(59, 130, 246, 0.5)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        indexAxis: 'y', // Torna o gráfico de barras horizontal
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                ticks: { stepSize: 1 }
                            }
                        }
                    }
                });
            };

            // 3. Cria os dois gráficos
            graficoEntidadesOrg = criarGrafico('grafico-entidades-org', orgCounts, 'Nº de Citações');
            graficoEntidadesLoc = criarGrafico('grafico-entidades-loc', locCounts, 'Nº de Citações');
        }

        /**
         * Renderiza um gráfico de barras para as metodologias mais utilizadas.
         */
         function renderizarGraficoMetodologias(trabalhos) {
            if (graficoMetodologias) graficoMetodologias.destroy();

            const metodologiaCounts = new Map();

            // 1. Processa e conta todas as metodologias
            trabalhos.forEach(trabalho => {
                if (trabalho.methodologies && trabalho.methodologies.length > 0) {
                    trabalho.methodologies.forEach(metodo => {
                        // Normaliza para evitar contagens duplas (ex: "Estudo de Caso" e "estudo de caso")
                        const metodoNormalizado = metodo.charAt(0).toUpperCase() + metodo.slice(1).toLowerCase();
                        metodologiaCounts.set(metodoNormalizado, (metodologiaCounts.get(metodoNormalizado) || 0) + 1);
                    });
                }
            });

            // 2. Prepara os dados para o gráfico
            const top15 = Array.from(metodologiaCounts.entries())
                .sort((a, b) => b[1] - a[1]) // Ordena por contagem
                .slice(0, 15) // Pega as 15 principais
                .reverse(); // Inverte para o maior ficar no topo

            // 3. Cria o gráfico
            const ctx = document.getElementById('grafico-metodologias').getContext('2d');
            graficoMetodologias = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: top15.map(item => item[0]),
                    datasets: [{
                        label: 'Nº de Trabalhos',
                        data: top15.map(item => item[1]),
                        backgroundColor: 'rgba(16, 185, 129, 0.5)', // Tom de verde
                        borderColor: 'rgba(16, 185, 129, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: 'Top 15 Metodologias por Frequência'
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });
        }

        function escapeRegExp(str) {
            return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        function buscarPorTermo(termo) {
            fecharModal();
            const searchInput = document.getElementById('filtro-busca-textual');
            searchInput.value = termo;
            // Dispara o evento de 'input' para ativar o debounce da busca
            searchInput.dispatchEvent(new Event('input', { bubbles: true }));
            // Rola a página para a seção de trabalhos após um pequeno atraso
            setTimeout(() => {
                document.getElementById('trabalhos').scrollIntoView({ behavior: 'smooth' });
            }, 100);
        }

        function destacarEntidades(texto, entidades) {
            if (!texto || !entidades || entidades.length === 0) {
                return texto;
            }
            // Ordena as entidades pela mais longa primeiro para evitar substituições parciais
            const sortedEntities = [...entidades].sort((a, b) => b.text.length - a.text.length);
            let textoDestacado = texto;
            
            // Usamos um Set para não processar o mesmo texto duas vezes, caso haja entidades sobrepostas
            const textosJaProcessados = new Set();

            sortedEntities.forEach(entidade => {
                // Pula se o texto exato já foi transformado em um span HTML
                if (textosJaProcessados.has(entidade.text.toLowerCase())) return;

                const entityClass = `entity entity-${entidade.type || 'MISC'}`;
                // Escapa aspas simples que possam quebrar o HTML do onclick
                const textoParaBusca = escapeRegExp(entidade.text.replace(/'/g, "\\'"));
                const replacementHTML = `<span class="${entityClass}" onclick="buscarPorTermo('${textoParaBusca}')">${entidade.text}</span>`;
                
                // Usa Regex para substituir todas as ocorrências da entidade (case-insensitive e global)
                // A flag 'g' garante que todas as ocorrências sejam substituídas, não apenas a primeira.
                const regex = new RegExp(escapeRegExp(entidade.text), 'g');
                if (regex.test(textoDestacado)) {
                    textoDestacado = textoDestacado.replace(regex, replacementHTML);
                    textosJaProcessados.add(entidade.text.toLowerCase());
                }
            });

            return textoDestacado;
        }

        function renderizarFiltrosDeTopico() {
            const container = document.getElementById('topic-filters');
            container.innerHTML = '';
            const criarBotao = (texto, id) => {
                const button = document.createElement('button');
                button.textContent = texto;
                button.dataset.topicId = id;
                button.className = 'px-3 py-1 text-sm font-medium border rounded-full transition-colors duration-200 text-gray-700 bg-white border-gray-300 hover:bg-gray-100';
                button.addEventListener('click', () => filtrarPorTopico(id));
                return button;
            };
            for (const [id, name] of Object.entries(topicMap)) {
                container.appendChild(criarBotao(name, id));
            }
        }

        function filtrarPorTopico(topicId) {
            const topicIdNum = parseInt(topicId, 10);
            // Desativa o tópico se ele já estiver ativo
            if (activeTopic === topicIdNum) {
                activeTopic = null;
            } else {
                activeTopic = topicIdNum;
            }
            
            // Atualiza a aparência dos botões
            document.querySelectorAll('#topic-filters button').forEach(btn => {
                if (parseInt(btn.dataset.topicId, 10) === activeTopic) {
                    btn.classList.remove('bg-white', 'text-gray-700', 'border-gray-300');
                    btn.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
                } else {
                    btn.classList.add('bg-white', 'text-gray-700', 'border-gray-300');
                    btn.classList.remove('bg-blue-600', 'text-white', 'border-blue-600');
                }
            });

            aplicarFiltros(); // Re-aplica todos os filtros, incluindo o de tópico
        }
        
        /**
         * Analisa o dataset para criar dinamicamente um mapa de IDs de tópicos para nomes genéricos.
         * Isso garante que todos os tópicos presentes nos dados sejam representados.
         */
        function gerarTopicMapDinamico() {
            const topicosEncontrados = new Set();
            data.forEach(trabalho => {
                // Verifica se o campo 'topic' existe e não é nulo/undefined
                if (trabalho.topic !== undefined && trabalho.topic !== null) {
                    topicosEncontrados.add(trabalho.topic);
                }
            });

            // Ordena os tópicos numericamente para garantir uma ordem consistente nos filtros
            const topicosOrdenados = Array.from(topicosEncontrados).sort((a, b) => a - b);

            // Limpa o mapa antigo e preenche com os novos tópicos encontrados
            topicMap = {};
            topicosOrdenados.forEach(id => {
                // Cria um nome genérico para cada tópico. Ex: "Tópico 1", "Tópico 2", etc.
                topicMap[id] = `Tópico ${id}`;
            });
        }

        /**
         * Gera o mapa de tópicos a partir do campo 'topic_label' do dataset.
         */
         function gerarTopicMap() {
            topicMap = {}; // Limpa o mapa
            data.forEach(trabalho => {
                if (trabalho.topic && trabalho.topic_label) {
                    // Evita sobrescrever se já existir, garantindo um nome consistente
                    if (!topicMap[trabalho.topic]) {
                        topicMap[trabalho.topic] = trabalho.topic_label;
                    }
                }
            });
        }

        /**
         * Renderiza os botões de filtro para cada tópico no mapa.
         */
        function renderizarFiltrosDeTopico() {
            const container = document.getElementById('topic-filters');
            container.innerHTML = ''; // Limpa antes de renderizar
            
            // Ordena os tópicos pelo ID numérico para uma exibição consistente
            const topicosOrdenados = Object.entries(topicMap).sort((a, b) => a[0] - b[0]);

            for (const [id, name] of topicosOrdenados) {
                const button = document.createElement('button');
                button.textContent = name;
                button.dataset.topicId = id;
                button.className = 'px-3 py-1 text-sm font-medium border rounded-full transition-colors duration-200 text-gray-700 bg-white border-gray-300 hover:bg-gray-100';
                button.addEventListener('click', () => filtrarPorTopico(parseInt(id, 10)));
                container.appendChild(button);
            }
        }

        /**
         * Ativa/desativa o filtro por tópico e atualiza o dashboard.
         * @param {number} topicId O ID do tópico clicado.
         */
        function filtrarPorTopico(topicId) {
            // Desativa o filtro se o mesmo tópico for clicado novamente
            if (activeTopic === topicId) {
                activeTopic = null;
            } else {
                activeTopic = topicId;
            }
            
            // Atualiza a aparência visual dos botões
            document.querySelectorAll('#topic-filters button').forEach(btn => {
                if (parseInt(btn.dataset.topicId, 10) === activeTopic) {
                    btn.classList.remove('bg-white', 'text-gray-700', 'border-gray-300');
                    btn.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
                } else {
                    btn.classList.add('bg-white', 'text-gray-700', 'border-gray-300');
                    btn.classList.remove('bg-blue-600', 'text-white', 'border-blue-600');
                }
            });

            // Re-aplica todos os outros filtros junto com o de tópico
            aplicarFiltros(); 
        }

        // --- LÓGICA PARA O BANNER DE CONSENTIMENTO DE COOKIES ---
        function setupCookieConsent() {
            const banner = document.getElementById('cookie-consent-banner');
            const acceptBtn = document.getElementById('accept-cookie-consent');
            const COOKIE_CONSENT_KEY = 'cookie_consent_accepted';

            // Verifica se o usuário já aceitou os cookies
            if (localStorage.getItem(COOKIE_CONSENT_KEY) === 'true') {
                // Se já aceitou, não faz nada. O banner permanecerá escondido.
                return;
            }

            // Se não aceitou, mostra o banner após um pequeno atraso
            setTimeout(() => {
                banner.classList.add('show');
            }, 500); // Atraso de 500ms para exibir o banner

            // Adiciona o evento ao botão de aceitar
            acceptBtn.addEventListener('click', () => {
                // Salva a preferência do usuário no localStorage
                localStorage.setItem(COOKIE_CONSENT_KEY, 'true');
                // Esconde o banner
                banner.classList.remove('show');
            });
        }

        // Função para exportar PDF (VERSÃO MELHORADA)
        function exportarParaPDF() {
            alert("A exportação para PDF está sendo gerada. Este processo pode levar alguns instantes. Por favor, aguarde.");

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'p',
                unit: 'mm',
                format: 'a4'
            });

            // Seleciona o container principal que queremos exportar
            const content = document.querySelector('.container');
            
            html2canvas(content, {
                // Aumentar a escala melhora drasticamente a resolução da imagem
                scale: 2.5, 
                useCORS: true,
                logging: false,
                backgroundColor: '#ffffff'
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/jpeg', 0.95);
                const imgWidth = 210; // Largura de uma página A4 em mm
                const pageHeight = 295; // Altura de uma página A4 em mm
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;

                // Adiciona a primeira parte da imagem
                doc.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                // Adiciona novas páginas para o restante da imagem
                while (heightLeft > 0) {
                    position = heightLeft - imgHeight;
                    doc.addPage();
                    doc.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                
                doc.save('relatorio-trabalhos-academicos-uff.pdf');
            }).catch(error => {
                console.error("Erro ao gerar o PDF:", error);
                alert("Ocorreu um erro ao tentar gerar o PDF. Verifique o console para mais detalhes.");
            });
        }
    
        // --- INICIALIZAÇÃO ---
        // O evento DOMContentLoaded agora apenas chama a nossa função principal.
        document.addEventListener('DOMContentLoaded', iniciarAplicacao);

    </script>
</body>
</html>